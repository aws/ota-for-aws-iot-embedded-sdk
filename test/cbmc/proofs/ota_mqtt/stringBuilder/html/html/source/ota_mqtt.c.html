
<html>
<head>
<title>source/ota_mqtt.c</title>
<link rel="stylesheet" type="text/css" href="../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * AWS IoT Over-the-air Update v3.0.0</div><div id="3" class="line none">    3  * Copyright (C) 2020 Amazon.com, Inc. or its affiliates.  All Rights Reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * Permission is hereby granted, free of charge, to any person obtaining a copy of</div><div id="6" class="line none">    6  * this software and associated documentation files (the "Software"), to deal in</div><div id="7" class="line none">    7  * the Software without restriction, including without limitation the rights to</div><div id="8" class="line none">    8  * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</div><div id="9" class="line none">    9  * the Software, and to permit persons to whom the Software is furnished to do so,</div><div id="10" class="line none">   10  * subject to the following conditions:</div><div id="11" class="line none">   11  *</div><div id="12" class="line none">   12  * The above copyright notice and this permission notice shall be included in all</div><div id="13" class="line none">   13  * copies or substantial portions of the Software.</div><div id="14" class="line none">   14  *</div><div id="15" class="line none">   15  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</div><div id="16" class="line none">   16  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS</div><div id="17" class="line none">   17  * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR</div><div id="18" class="line none">   18  * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER</div><div id="19" class="line none">   19  * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</div><div id="20" class="line none">   20  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</div><div id="21" class="line none">   21  */</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 /**</div><div id="24" class="line none">   24  * @file ota_mqtt.c</div><div id="25" class="line none">   25  * @brief Routines for supporting over the air updates using MQTT.</div><div id="26" class="line none">   26  */</div><div id="27" class="line none">   27 </div><div id="28" class="line none">   28 /* Standard includes. */</div><div id="29" class="line none">   29 #include &lt;string.h&gt;</div><div id="30" class="line none">   30 #include &lt;stdio.h&gt;</div><div id="31" class="line none">   31 #include &lt;stdlib.h&gt;</div><div id="32" class="line none">   32 #include &lt;assert.h&gt;</div><div id="33" class="line none">   33 </div><div id="34" class="line none">   34 /* OTA includes. */</div><div id="35" class="line none">   35 #include "ota.h"</div><div id="36" class="line none">   36 #include "ota_private.h"</div><div id="37" class="line none">   37 #include "ota_cbor_private.h"</div><div id="38" class="line none">   38 </div><div id="39" class="line none">   39 /* Private include. */</div><div id="40" class="line none">   40 #include "ota_mqtt_private.h"</div><div id="41" class="line none">   41 </div><div id="42" class="line none">   42 /* Include firmware version struct definition. */</div><div id="43" class="line none">   43 #include "ota_appversion32.h"</div><div id="44" class="line none">   44 </div><div id="45" class="line none">   45 /* Stream GET message constants. */</div><div id="46" class="line none">   46 #define <a href="ota_mqtt.c.html#46">OTA_CLIENT_TOKEN</a>             "rdy"                  /*!&lt; Arbitrary client token sent in the stream "GET" message. */</div><div id="47" class="line none">   47 </div><div id="48" class="line none">   48 /* Agent to Job Service status message constants. */</div><div id="49" class="line none">   49 #define <a href="ota_mqtt.c.html#49">OTA_STATUS_MSG_MAX_SIZE</a>      128U               /*!&lt; Max length of a job status message to the service. */</div><div id="50" class="line none">   50 </div><div id="51" class="line none">   51 /**</div><div id="52" class="line none">   52  *  @brief Topic strings used by the OTA process.</div><div id="53" class="line none">   53  *</div><div id="54" class="line none">   54  * These first few are topic extensions to the dynamic base topic that includes the Thing name.</div><div id="55" class="line none">   55  */</div><div id="56" class="line none">   56 #define <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a>              "$aws/things/"                   /*!&lt; Topic prefix for thing APIs. */</div><div id="57" class="line none">   57 #define <a href="ota_mqtt.c.html#57">MQTT_API_JOBS_NEXT_GET</a>       "/jobs/$next/get"                /*!&lt; Topic suffix for job API. */</div><div id="58" class="line none">   58 #define <a href="ota_mqtt.c.html#58">MQTT_API_JOBS_NOTIFY_NEXT</a>    "/jobs/notify-next"              /*!&lt; Topic suffix for job API. */</div><div id="59" class="line none">   59 #define <a href="ota_mqtt.c.html#59">MQTT_API_JOBS</a>                "/jobs/"                         /*!&lt; Job API identifier. */</div><div id="60" class="line none">   60 #define <a href="ota_mqtt.c.html#60">MQTT_API_UPDATE</a>              "/update"                        /*!&lt; Job API identifier. */</div><div id="61" class="line none">   61 #define <a href="ota_mqtt.c.html#61">MQTT_API_STREAMS</a>             "/streams/"                      /*!&lt; Stream API identifier. */</div><div id="62" class="line none">   62 #define <a href="ota_mqtt.c.html#62">MQTT_API_DATA_CBOR</a>           "/data/cbor"                     /*!&lt; Stream API suffix. */</div><div id="63" class="line none">   63 #define <a href="ota_mqtt.c.html#63">MQTT_API_GET_CBOR</a>            "/get/cbor"                      /*!&lt; Stream API suffix. */</div><div id="64" class="line none">   64 </div><div id="65" class="line none">   65 /* NOTE: The format specifiers in this string are placeholders only; the lengths of these</div><div id="66" class="line none">   66  * strings are used to calculate buffer sizes.</div><div id="67" class="line none">   67  */</div><div id="68" class="line none">   68 static const char <a href="ota_mqtt.c.html#68">pOtaJobsGetNextTopicTemplate</a>[] = <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a> "%s"<a href="ota_mqtt.c.html#57">MQTT_API_JOBS_NEXT_GET</a>;                 /*!&lt; Topic template to request next job. */</div><div id="69" class="line none">   69 static const char <a href="ota_mqtt.c.html#69">pOtaJobsNotifyNextTopicTemplate</a>[] = <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a> "%s"<a href="ota_mqtt.c.html#58">MQTT_API_JOBS_NOTIFY_NEXT</a>;           /*!&lt; Topic template to notify next . */</div><div id="70" class="line none">   70 static const char <a href="ota_mqtt.c.html#70">pOtaJobStatusTopicTemplate</a>[] = <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a> "%s"<a href="ota_mqtt.c.html#59">MQTT_API_JOBS</a> "%s"<a href="ota_mqtt.c.html#60">MQTT_API_UPDATE</a>;        /*!&lt; Topic template to update the current job. */</div><div id="71" class="line none">   71 static const char <a href="ota_mqtt.c.html#71">pOtaStreamDataTopicTemplate</a>[] = <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a> "%s"<a href="ota_mqtt.c.html#61">MQTT_API_STREAMS</a> "%s"<a href="ota_mqtt.c.html#62">MQTT_API_DATA_CBOR</a>; /*!&lt; Topic template to receive data over a stream. */</div><div id="72" class="line none">   72 static const char <a href="ota_mqtt.c.html#72">pOtaGetStreamTopicTemplate</a>[] = <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a> "%s"<a href="ota_mqtt.c.html#61">MQTT_API_STREAMS</a> "%s"<a href="ota_mqtt.c.html#63">MQTT_API_GET_CBOR</a>;   /*!&lt; Topic template to request next data over a stream. */</div><div id="73" class="line none">   73 </div><div id="74" class="line none">   74 static const char <a href="ota_mqtt.c.html#74">pOtaGetNextJobMsgTemplate</a>[] = "{\"clientToken\":\"%u:%s\"}";                                 /*!&lt; Used to specify client token id to authenticate job. */</div><div id="75" class="line none">   75 static const char <a href="ota_mqtt.c.html#75">pOtaStringReceive</a>[] = "\"receive\"";                                                         /*!&lt; Used to build the job receive template. */</div><div id="76" class="line none">   76 </div><div id="77" class="line none">   77 /** We map all of the above status cases to one of these status strings.</div><div id="78" class="line none">   78  * These are the only strings that are supported by the Job Service. You</div><div id="79" class="line none">   79  * shall not change them to arbitrary strings or the job will not change</div><div id="80" class="line none">   80  * states.</div><div id="81" class="line none">   81  * */</div><div id="82" class="line none">   82 #define <a href="ota_mqtt.c.html#82">JOBS_API_STATUS_IN_PROGRESS</a>    "IN_PROGRESS" /*!&lt; The job document has be received on the device and update is in progress. */</div><div id="83" class="line none">   83 #define <a href="ota_mqtt.c.html#83">JOBS_API_STATUS_FAILED</a>         "FAILED"      /*!&lt; OTA update failed due to an error. */</div><div id="84" class="line none">   84 #define <a href="ota_mqtt.c.html#84">JOBS_API_STATUS_SUCCEEDED</a>      "SUCCEEDED"   /*!&lt; OTA update succeeded. */</div><div id="85" class="line none">   85 #define <a href="ota_mqtt.c.html#85">JOBS_API_STATUS_REJECTED</a>       "REJECTED"    /*!&lt; The job was rejected due to invalid parameters. */</div><div id="86" class="line none">   86 </div><div id="87" class="line none">   87 /**</div><div id="88" class="line none">   88  * @brief List of all the status cases a job can be in.</div><div id="89" class="line none">   89  *</div><div id="90" class="line none">   90  */</div><div id="91" class="line none">   91 static const char * <a href="ota_mqtt.c.html#91">pOtaJobStatusStrings</a>[ <a href="include/ota.h.html#183">NumJobStatusMappings</a> ] =</div><div id="92" class="line none">   92 {</div><div id="93" class="line none">   93     "{\"status\":\""<a href="ota_mqtt.c.html#82">JOBS_API_STATUS_IN_PROGRESS</a> "\",\"statusDetails\":{",</div><div id="94" class="line none">   94     "{\"status\":\""<a href="ota_mqtt.c.html#83">JOBS_API_STATUS_FAILED</a> "\",\"statusDetails\":{",</div><div id="95" class="line none">   95     "{\"status\":\""<a href="ota_mqtt.c.html#84">JOBS_API_STATUS_SUCCEEDED</a> "\",\"statusDetails\":{",</div><div id="96" class="line none">   96     "{\"status\":\""<a href="ota_mqtt.c.html#85">JOBS_API_STATUS_REJECTED</a> "\",\"statusDetails\":{",</div><div id="97" class="line none">   97     "{\"status\":\""<a href="ota_mqtt.c.html#83">JOBS_API_STATUS_FAILED</a> "\",\"statusDetails\":{", /* eJobStatus_FailedWithVal */</div><div id="98" class="line none">   98 };</div><div id="99" class="line none">   99 </div><div id="100" class="line none">  100 /**</div><div id="101" class="line none">  101  * @brief These are the associated statusDetails 'reason' codes that go along with</div><div id="102" class="line none">  102  * the above enums during the OTA update process. The 'Receiving' state is</div><div id="103" class="line none">  103  * updated with transfer progress as number of blocks received of total blocks.</div><div id="104" class="line none">  104  *</div><div id="105" class="line none">  105  */</div><div id="106" class="line none">  106 static const char * <a href="ota_mqtt.c.html#106">pOtaJobReasonStrings</a>[ <a href="include/ota_private.h.html#234">NumJobReasons</a> ] = { "", "ready", "active", "accepted", "rejected", "aborted" };</div><div id="107" class="line none">  107 </div><div id="108" class="line none">  108 /**</div><div id="109" class="line none">  109  * @brief These are used for both decimal and hex string conversions.</div><div id="110" class="line none">  110  */</div><div id="111" class="line none">  111 static const char <a href="ota_mqtt.c.html#111">asciiDigits</a>[] =</div><div id="112" class="line none">  112 {</div><div id="113" class="line none">  113     '0', '1', '2', '3',</div><div id="114" class="line none">  114     '4', '5', '6', '7',</div><div id="115" class="line none">  115     '8', '9', 'a', 'b',</div><div id="116" class="line none">  116     'c', 'd', 'e', 'f',</div><div id="117" class="line none">  117 };</div><div id="118" class="line none">  118 </div><div id="119" class="line none">  119 /* Maximum lengths for constants used in the ota_mqtt_topic_strings templates.</div><div id="120" class="line none">  120  * These are used to calculate the static size of buffers used to store MQTT</div><div id="121" class="line none">  121  * topic and message strings. Each length is in terms of bytes. */</div><div id="122" class="line none">  122 #define <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a>            10U                                              /*!&lt; Maximum number of output digits of an unsigned long value. */</div><div id="123" class="line none">  123 #define <a href="ota_mqtt.c.html#123">JOB_NAME_MAX_LEN</a>       128U                                             /*!&lt; Maximum length of the name of job documents received from the server. */</div><div id="124" class="line none">  124 #define <a href="ota_mqtt.c.html#124">STREAM_NAME_MAX_LEN</a>    44U                                              /*!&lt; Maximum length for the name of MQTT streams. */</div><div id="125" class="line none">  125 #define <a href="ota_mqtt.c.html#125">NULL_CHAR_LEN</a>          1U                                               /*!&lt; Size of a single null character used to terminate topics and messages. */</div><div id="126" class="line none">  126 </div><div id="127" class="line none">  127 /* Pre-calculate max buffer size for mqtt topics and messages. We make sure the buffer size is large</div><div id="128" class="line none">  128  * enough to hold a dynamically constructed topic and message string.</div><div id="129" class="line none">  129  */</div><div id="130" class="line none">  130 #define <a href="ota_mqtt.c.html#130">TOPIC_PLUS_THINGNAME_LEN</a>( topic )    ( <a href="include/ota.h.html#47">CONST_STRLEN</a>( topic ) + otaconfigMAX_THINGNAME_LEN + <a href="ota_mqtt.c.html#125">NULL_CHAR_LEN</a> )              /*!&lt; Calculate max buffer size based on topic template and thing name length. */</div><div id="131" class="line none">  131 #define <a href="ota_mqtt.c.html#131">TOPIC_GET_NEXT_BUFFER_SIZE</a>       ( <a href="ota_mqtt.c.html#130">TOPIC_PLUS_THINGNAME_LEN</a>( <a href="ota_mqtt.c.html#68">pOtaJobsGetNextTopicTemplate</a> ) )                            /*!&lt; Max buffer size for `jobs/$next/get` topic. */</div><div id="132" class="line none">  132 #define <a href="ota_mqtt.c.html#132">TOPIC_NOTIFY_NEXT_BUFFER_SIZE</a>    ( <a href="ota_mqtt.c.html#130">TOPIC_PLUS_THINGNAME_LEN</a>( <a href="ota_mqtt.c.html#69">pOtaJobsNotifyNextTopicTemplate</a> ) )                         /*!&lt; Max buffer size for `jobs/notify-next` topic. */</div><div id="133" class="line none">  133 #define <a href="ota_mqtt.c.html#133">TOPIC_JOB_STATUS_BUFFER_SIZE</a>     ( <a href="ota_mqtt.c.html#130">TOPIC_PLUS_THINGNAME_LEN</a>( <a href="ota_mqtt.c.html#70">pOtaJobStatusTopicTemplate</a> ) + <a href="ota_mqtt.c.html#123">JOB_NAME_MAX_LEN</a> )           /*!&lt; Max buffer size for `jobs/&lt;job_name&gt;/update` topic. */</div><div id="134" class="line none">  134 #define <a href="ota_mqtt.c.html#134">TOPIC_STREAM_DATA_BUFFER_SIZE</a>    ( <a href="ota_mqtt.c.html#130">TOPIC_PLUS_THINGNAME_LEN</a>( <a href="ota_mqtt.c.html#71">pOtaStreamDataTopicTemplate</a> ) + <a href="ota_mqtt.c.html#124">STREAM_NAME_MAX_LEN</a> )       /*!&lt; Max buffer size for `streams/&lt;stream_name&gt;/data/cbor` topic. */</div><div id="135" class="line none">  135 #define <a href="ota_mqtt.c.html#135">TOPIC_GET_STREAM_BUFFER_SIZE</a>     ( <a href="ota_mqtt.c.html#130">TOPIC_PLUS_THINGNAME_LEN</a>( <a href="ota_mqtt.c.html#72">pOtaGetStreamTopicTemplate</a> ) + <a href="ota_mqtt.c.html#124">STREAM_NAME_MAX_LEN</a> )        /*!&lt; Max buffer size for `streams/&lt;stream_name&gt;/get/cbor` topic. */</div><div id="136" class="line none">  136 #define <a href="ota_mqtt.c.html#136">MSG_GET_NEXT_BUFFER_SIZE</a>         ( <a href="ota_mqtt.c.html#130">TOPIC_PLUS_THINGNAME_LEN</a>( <a href="ota_mqtt.c.html#74">pOtaGetNextJobMsgTemplate</a> ) + <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> )                 /*!&lt; Max buffer size for message of `jobs/$next/get topic`. */</div><div id="137" class="line none">  137 </div><div id="138" class="line none">  138 /**</div><div id="139" class="line none">  139  * @brief Subscribe to the jobs notification topic (i.e. New file version available).</div><div id="140" class="line none">  140  *</div><div id="141" class="line none">  141  * @param[in] pAgentCtx Agent context which stores the thing details and mqtt interface.</div><div id="142" class="line none">  142  * @return OtaMqttStatus_t Result of the subscribe operation, OtaMqttSuccess if the operation is successful</div><div id="143" class="line none">  143  */</div><div id="144" class="line none">  144 static <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="ota_mqtt.c.html#344">subscribeToJobNotificationTopics</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx );</div><div id="145" class="line none">  145 </div><div id="146" class="line none">  146 /**</div><div id="147" class="line none">  147  * @brief UnSubscribe from the firmware update receive topic.</div><div id="148" class="line none">  148  *</div><div id="149" class="line none">  149  * @param[in] pAgentCtx Agent context which stores the thing details and mqtt interface.</div><div id="150" class="line none">  150  * @return OtaMqttStatus_t Result of the unsubscribe operation, OtaMqttSuccess if the operation is successful.</div><div id="151" class="line none">  151  */</div><div id="152" class="line none">  152 static <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="ota_mqtt.c.html#399">unsubscribeFromDataStream</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx );</div><div id="153" class="line none">  153 </div><div id="154" class="line none">  154 /**</div><div id="155" class="line none">  155  * @brief UnSubscribe from the jobs notification topic.</div><div id="156" class="line none">  156  *</div><div id="157" class="line none">  157  * @param[in] pAgentCtx Agent context which stores the thing details and mqtt interface.</div><div id="158" class="line none">  158  * @return OtaMqttStatus_t Result of the unsubscribe operation, OtaMqttSuccess if the operation is successful.</div><div id="159" class="line none">  159  */</div><div id="160" class="line none">  160 static <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="ota_mqtt.c.html#460">unsubscribeFromJobNotificationTopic</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx );</div><div id="161" class="line none">  161 </div><div id="162" class="line none">  162 /**</div><div id="163" class="line none">  163  * @brief Publish a message to the job status topic.</div><div id="164" class="line none">  164  *</div><div id="165" class="line none">  165  * @param[in] pAgentCtx Agent context which provides the details for the thing, job and mqtt interface.</div><div id="166" class="line none">  166  * @param[in] pMsg Message to publish.</div><div id="167" class="line none">  167  * @param[in] msgSize Size of message to send.</div><div id="168" class="line none">  168  * @param[in] qos Quality of service level for mqtt.</div><div id="169" class="line none">  169  * @return OtaMqttStatus_t OtaMqttSuccess if the message is publish is successful.</div><div id="170" class="line none">  170  */</div><div id="171" class="line none">  171 static <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="ota_mqtt.c.html#517">publishStatusMessage</a>( <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx,</div><div id="172" class="line none">  172                                              const char * pMsg,</div><div id="173" class="line none">  173                                              uint32_t msgSize,</div><div id="174" class="line none">  174                                              uint8_t qos );</div><div id="175" class="line none">  175 </div><div id="176" class="line none">  176 /**</div><div id="177" class="line none">  177  * @brief Populate the message buffer with the job status message.</div><div id="178" class="line none">  178  *</div><div id="179" class="line none">  179  * @param[in] pMsgBuffer Buffer to populate.</div><div id="180" class="line none">  180  * @param[in] msgBufferSize Size of the message.</div><div id="181" class="line none">  181  * @param[in] status Status of the operation.</div><div id="182" class="line none">  182  * @param[in] pOTAFileCtx File context stores the information about the downloaded blocks and required size.</div><div id="183" class="line none">  183  * @return uint32_t Size of the message built.</div><div id="184" class="line none">  184  */</div><div id="185" class="line none">  185 static uint32_t <a href="ota_mqtt.c.html#586">buildStatusMessageReceiving</a>( char * pMsgBuffer,</div><div id="186" class="line none">  186                                              size_t msgBufferSize,</div><div id="187" class="line none">  187                                              <a href="include/ota.h.html#184">OtaJobStatus_t</a> <a href="include/ota.h.html#202">status</a>,</div><div id="188" class="line none">  188                                              const <a href="include/ota_private.h.html#408">OtaFileContext_t</a> * pOTAFileCtx );</div><div id="189" class="line none">  189 </div><div id="190" class="line none">  190 /**</div><div id="191" class="line none">  191  * @brief Populate the message buffer with the message to indicate device in self-test.</div><div id="192" class="line none">  192  *</div><div id="193" class="line none">  193  * @param[in] pMsgBuffer Buffer to populate.</div><div id="194" class="line none">  194  * @param[in] msgBufferSize Size of the message.</div><div id="195" class="line none">  195  * @param[in] status Status of the operation.</div><div id="196" class="line none">  196  * @param[in] reason Reason for job failure (if any).</div><div id="197" class="line none">  197  * @return uint32_t Size of the message.</div><div id="198" class="line none">  198  */</div><div id="199" class="line none">  199 static uint32_t <a href="ota_mqtt.c.html#643">prvBuildStatusMessageSelfTest</a>( char * pMsgBuffer,</div><div id="200" class="line none">  200                                                size_t msgBufferSize,</div><div id="201" class="line none">  201                                                <a href="include/ota.h.html#184">OtaJobStatus_t</a> <a href="include/ota.h.html#202">status</a>,</div><div id="202" class="line none">  202                                                int32_t <a href="include/ota.h.html#203">reason</a> );</div><div id="203" class="line none">  203 </div><div id="204" class="line none">  204 /**</div><div id="205" class="line none">  205  * @brief Populate the response message with the status of the job.</div><div id="206" class="line none">  206  *</div><div id="207" class="line none">  207  * @param[in] pMsgBuffer Buffer to populate.</div><div id="208" class="line none">  208  * @param[in] msgBufferSize Size of the message.</div><div id="209" class="line none">  209  * @param[in] status Status of the operation.</div><div id="210" class="line none">  210  * @param[in] reason Reason for failure or the new firmware version.</div><div id="211" class="line none">  211  * @param[in] subReason Error code due to which the operation failed.</div><div id="212" class="line none">  212  * @return uint32_t Size of the message.</div><div id="213" class="line none">  213  */</div><div id="214" class="line none">  214 static uint32_t <a href="ota_mqtt.c.html#686">prvBuildStatusMessageFinish</a>( char * pMsgBuffer,</div><div id="215" class="line none">  215                                              size_t msgBufferSize,</div><div id="216" class="line none">  216                                              <a href="include/ota.h.html#184">OtaJobStatus_t</a> <a href="include/ota.h.html#202">status</a>,</div><div id="217" class="line none">  217                                              int32_t <a href="include/ota.h.html#203">reason</a>,</div><div id="218" class="line none">  218                                              int32_t <a href="include/ota.h.html#204">subReason</a> );</div><div id="219" class="line none">  219 </div><div id="220" class="line none">  220 /**</div><div id="221" class="line none">  221  * @brief Build a string from a set of strings</div><div id="222" class="line none">  222  *</div><div id="223" class="line none">  223  * @param[in] pBuffer Buffer to place the output string in.</div><div id="224" class="line none">  224  * @param[in] bufferSizeBytes Size of the buffer pointed to by pBuffer.</div><div id="225" class="line none">  225  * @param[in] strings NULL-terminated array of string pointers.</div><div id="226" class="line none">  226  * @return size_t Length of the output string, not including the terminator.</div><div id="227" class="line none">  227  */</div><div id="228" class="line none">  228 static size_t <a href="ota_mqtt.c.html#256">stringBuilder</a>( char * pBuffer,</div><div id="229" class="line none">  229                              size_t bufferSizeBytes,</div><div id="230" class="line none">  230                              const char * strings[] );</div><div id="231" class="line none">  231 </div><div id="232" class="line none">  232 /**</div><div id="233" class="line none">  233  * @brief Build a string with the decimal representation of a uint32_t value.</div><div id="234" class="line none">  234  *</div><div id="235" class="line none">  235  * @param[in] pBuffer Buffer to place the output string in.</div><div id="236" class="line none">  236  * @param[in] bufferSizeBytes Size of the buffer pointed to by pBuffer.</div><div id="237" class="line none">  237  * @param[in] value The uint32_t value to convert.</div><div id="238" class="line none">  238  * @return size_t Length of the output string, not including the terminator.</div><div id="239" class="line none">  239  */</div><div id="240" class="line none">  240 static size_t <a href="ota_mqtt.c.html#281">stringBuilderUInt32Decimal</a>( char * pBuffer,</div><div id="241" class="line none">  241                                           size_t bufferSizeBytes,</div><div id="242" class="line none">  242                                           uint32_t value );</div><div id="243" class="line none">  243 </div><div id="244" class="line none">  244 /**</div><div id="245" class="line none">  245  * @brief Build a string with the hex representation of a uint32_t value.</div><div id="246" class="line none">  246  *</div><div id="247" class="line none">  247  * @param[in] pBuffer Buffer to place the output string in.</div><div id="248" class="line none">  248  * @param[in] bufferSizeBytes Size of the buffer pointed to by pBuffer.</div><div id="249" class="line none">  249  * @param[in] value The uint32_t value to convert.</div><div id="250" class="line none">  250  * @return size_t Length of the output string, not including the terminator.</div><div id="251" class="line none">  251  */</div><div id="252" class="line none">  252 static size_t <a href="ota_mqtt.c.html#310">stringBuilderUInt32Hex</a>( char * pBuffer,</div><div id="253" class="line none">  253                                       size_t bufferSizeBytes,</div><div id="254" class="line none">  254                                       uint32_t value );</div><div id="255" class="line none">  255 </div><div id="256" class="line none">  256 static size_t <a href="ota_mqtt.c.html#256">stringBuilder</a>( char * pBuffer,</div><div id="257" class="line none">  257                              size_t bufferSizeBytes,</div><div id="258" class="line none">  258                              const char * strings[] )</div><div id="259" class="line none">  259 {</div><div id="260" class="line hit">  260     size_t curLen = 0;</div><div id="261" class="line hit">  261     int i;</div><div id="262" class="line hit">  262     size_t thisLength = 0;</div><div id="263" class="line none">  263 </div><div id="264" class="line hit">  264     pBuffer[ 0 ] = '\0';</div><div id="265" class="line none">  265 </div><div id="266" class="line hit">  266     for( i = 0; strings[ i ] != NULL; i++ )</div><div id="267" class="line none">  267     {</div><div id="268" class="line hit">  268         thisLength = strlen( strings[ i ] );</div><div id="269" class="line none">  269 </div><div id="270" class="line none">  270         /* Assert if there is not enough buffer space. */</div><div id="271" class="line none">  271 </div><div id="272" class="line hit">  272         assert( thisLength + curLen + 1 &lt;= bufferSizeBytes );</div><div id="273" class="line none">  273 </div><div id="274" class="line hit">  274         ( void ) strncat( pBuffer, strings[ i ], bufferSizeBytes - curLen - 1U );</div><div id="275" class="line hit">  275         curLen += thisLength;</div><div id="276" class="line none">  276     }</div><div id="277" class="line none">  277 </div><div id="278" class="line hit">  278     return curLen;</div><div id="279" class="line hit">  279 }</div><div id="280" class="line none">  280 </div><div id="281" class="line none">  281 static size_t <a href="ota_mqtt.c.html#281">stringBuilderUInt32Decimal</a>( char * pBuffer,</div><div id="282" class="line none">  282                                           size_t bufferSizeBytes,</div><div id="283" class="line none">  283                                           uint32_t value )</div><div id="284" class="line none">  284 {</div><div id="285" class="line none">  285     char workBuf[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> ];</div><div id="286" class="line none">  286     char * pCur = workBuf;</div><div id="287" class="line none">  287     char * pDest = pBuffer;</div><div id="288" class="line none">  288     size_t <a href="include/ota_private.h.html#364">size</a> = 0;</div><div id="289" class="line none">  289 </div><div id="290" class="line none">  290     /* Assert if there is not enough buffer space. */</div><div id="291" class="line none">  291 </div><div id="292" class="line none">  292     assert( bufferSizeBytes &gt;= <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> );</div><div id="293" class="line none">  293     ( void ) bufferSizeBytes;</div><div id="294" class="line none">  294 </div><div id="295" class="line none">  295     while( value &gt; 0U )</div><div id="296" class="line none">  296     {</div><div id="297" class="line none">  297         *pCur++ = <a href="ota_mqtt.c.html#111">asciiDigits</a>[ ( value % 10U ) ];</div><div id="298" class="line none">  298         value /= 10U;</div><div id="299" class="line none">  299     }</div><div id="300" class="line none">  300 </div><div id="301" class="line none">  301     while( pCur &gt; workBuf )</div><div id="302" class="line none">  302     {</div><div id="303" class="line none">  303         pDest[ <a href="include/ota_private.h.html#364">size</a>++ ] = *--pCur;</div><div id="304" class="line none">  304     }</div><div id="305" class="line none">  305 </div><div id="306" class="line none">  306     pDest[ <a href="include/ota_private.h.html#364">size</a>++ ] = '\0';</div><div id="307" class="line none">  307     return <a href="include/ota_private.h.html#364">size</a>;</div><div id="308" class="line none">  308 }</div><div id="309" class="line none">  309 </div><div id="310" class="line none">  310 static size_t <a href="ota_mqtt.c.html#310">stringBuilderUInt32Hex</a>( char * pBuffer,</div><div id="311" class="line none">  311                                       size_t bufferSizeBytes,</div><div id="312" class="line none">  312                                       uint32_t value )</div><div id="313" class="line none">  313 {</div><div id="314" class="line none">  314     char workBuf[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> ];</div><div id="315" class="line none">  315     char * pCur = workBuf;</div><div id="316" class="line none">  316     char * pDest = pBuffer;</div><div id="317" class="line none">  317     size_t <a href="include/ota_private.h.html#364">size</a> = 0;</div><div id="318" class="line none">  318     int i;</div><div id="319" class="line none">  319 </div><div id="320" class="line none">  320     /* Assert if there is not enough buffer space. */</div><div id="321" class="line none">  321 </div><div id="322" class="line none">  322     assert( bufferSizeBytes &gt;= <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> );</div><div id="323" class="line none">  323     ( void ) bufferSizeBytes;</div><div id="324" class="line none">  324 </div><div id="325" class="line none">  325     /* Render all 8 digits, including leading zeros. */</div><div id="326" class="line none">  326     for( i = 0; i &lt; 8; i++ )</div><div id="327" class="line none">  327     {</div><div id="328" class="line none">  328         *pCur++ = <a href="ota_mqtt.c.html#111">asciiDigits</a>[ value &amp; 15U ]; /* 15U = 0xF*/</div><div id="329" class="line none">  329         value &gt;&gt;= 4;</div><div id="330" class="line none">  330     }</div><div id="331" class="line none">  331 </div><div id="332" class="line none">  332     while( pCur &gt; workBuf )</div><div id="333" class="line none">  333     {</div><div id="334" class="line none">  334         pDest[ <a href="include/ota_private.h.html#364">size</a>++ ] = *--pCur;</div><div id="335" class="line none">  335     }</div><div id="336" class="line none">  336 </div><div id="337" class="line none">  337     pDest[ <a href="include/ota_private.h.html#364">size</a>++ ] = '\0';</div><div id="338" class="line none">  338     return <a href="include/ota_private.h.html#364">size</a>;</div><div id="339" class="line none">  339 }</div><div id="340" class="line none">  340 </div><div id="341" class="line none">  341 /*</div><div id="342" class="line none">  342  * Subscribe to the OTA job notification topics.</div><div id="343" class="line none">  343  */</div><div id="344" class="line none">  344 static <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="ota_mqtt.c.html#344">subscribeToJobNotificationTopics</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="345" class="line none">  345 {</div><div id="346" class="line none">  346     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="347" class="line none">  347 </div><div id="348" class="line none">  348     uint16_t topicLen = 0;</div><div id="349" class="line none">  349 </div><div id="350" class="line none">  350     /* This buffer is used to store generated MQTT topics. The static size</div><div id="351" class="line none">  351      * are calculated from the templates and the corresponding parameters. */</div><div id="352" class="line none">  352     static char pJobTopicNotifyNext[ <a href="ota_mqtt.c.html#132">TOPIC_NOTIFY_NEXT_BUFFER_SIZE</a> ];</div><div id="353" class="line none">  353 </div><div id="354" class="line none">  354     /* NULL-terminated list of topic string components */</div><div id="355" class="line none">  355     const char * topicStringParts[] =</div><div id="356" class="line none">  356     {</div><div id="357" class="line none">  357         <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a>,</div><div id="358" class="line none">  358         NULL, /* Thing Name not available at compile time, initialized below */</div><div id="359" class="line none">  359         <a href="ota_mqtt.c.html#58">MQTT_API_JOBS_NOTIFY_NEXT</a>,</div><div id="360" class="line none">  360         NULL</div><div id="361" class="line none">  361     };</div><div id="362" class="line none">  362 </div><div id="363" class="line none">  363     assert( pAgentCtx != NULL );</div><div id="364" class="line none">  364 </div><div id="365" class="line none">  365     topicStringParts[ 1 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#290">pThingName</a>;</div><div id="366" class="line none">  366 </div><div id="367" class="line none">  367     topicLen = ( uint16_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="368" class="line none">  368         pJobTopicNotifyNext,</div><div id="369" class="line none">  369         sizeof( pJobTopicNotifyNext ),</div><div id="370" class="line none">  370         topicStringParts );</div><div id="371" class="line none">  371 </div><div id="372" class="line none">  372     /* The buffer is static and the size is calculated to fit. */</div><div id="373" class="line none">  373     assert( ( topicLen &gt; 0U ) &amp;&amp; ( topicLen &lt; sizeof( pJobTopicNotifyNext ) ) );</div><div id="374" class="line none">  374 </div><div id="375" class="line none">  375     mqttStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#253">mqtt</a>.<a href="include/ota_mqtt_interface.h.html#157">subscribe</a>( pJobTopicNotifyNext,</div><div id="376" class="line none">  376                                                            topicLen,</div><div id="377" class="line none">  377                                                            1 );</div><div id="378" class="line none">  378 </div><div id="379" class="line none">  379     if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="380" class="line none">  380     {</div><div id="381" class="line none">  381         LogInfo( ( "Subscribed to MQTT topic: %s", pJobTopicNotifyNext ) );</div><div id="382" class="line none">  382     }</div><div id="383" class="line none">  383     else</div><div id="384" class="line none">  384     {</div><div id="385" class="line none">  385         LogError( ( "Failed to subscribe to MQTT topic: "</div><div id="386" class="line none">  386                     "subscribe returned error: "</div><div id="387" class="line none">  387                     "OtaMqttStatus_t=%s"</div><div id="388" class="line none">  388                     ", topic=%s",</div><div id="389" class="line none">  389                     <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ),</div><div id="390" class="line none">  390                     pJobTopicNotifyNext ) );</div><div id="391" class="line none">  391     }</div><div id="392" class="line none">  392 </div><div id="393" class="line none">  393     return mqttStatus;</div><div id="394" class="line none">  394 }</div><div id="395" class="line none">  395 </div><div id="396" class="line none">  396 /*</div><div id="397" class="line none">  397  * UnSubscribe from the OTA data stream topic.</div><div id="398" class="line none">  398  */</div><div id="399" class="line none">  399 static <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="ota_mqtt.c.html#399">unsubscribeFromDataStream</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="400" class="line none">  400 {</div><div id="401" class="line none">  401     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="402" class="line none">  402 </div><div id="403" class="line none">  403     /* This buffer is used to store the generated MQTT topic. The static size</div><div id="404" class="line none">  404      * is calculated from the template and the corresponding parameters. */</div><div id="405" class="line none">  405     char pOtaRxStreamTopic[ <a href="ota_mqtt.c.html#134">TOPIC_STREAM_DATA_BUFFER_SIZE</a> ];</div><div id="406" class="line none">  406     uint16_t topicLen = 0;</div><div id="407" class="line none">  407     const <a href="include/ota_private.h.html#408">OtaFileContext_t</a> * pFileContext = NULL;</div><div id="408" class="line none">  408 </div><div id="409" class="line none">  409     /* NULL-terminated list of topic string parts. */</div><div id="410" class="line none">  410     const char * topicStringParts[] =</div><div id="411" class="line none">  411     {</div><div id="412" class="line none">  412         <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a>,</div><div id="413" class="line none">  413         NULL, /* Thing Name not available at compile time, initialized below. */</div><div id="414" class="line none">  414         <a href="ota_mqtt.c.html#61">MQTT_API_STREAMS</a>,</div><div id="415" class="line none">  415         NULL, /* Stream Name not available at compile time, initialized below. */</div><div id="416" class="line none">  416         <a href="ota_mqtt.c.html#62">MQTT_API_DATA_CBOR</a>,</div><div id="417" class="line none">  417         NULL</div><div id="418" class="line none">  418     };</div><div id="419" class="line none">  419 </div><div id="420" class="line none">  420     assert( pAgentCtx != NULL );</div><div id="421" class="line none">  421 </div><div id="422" class="line none">  422     pFileContext = &amp;( pAgentCtx-&gt;<a href="include/ota.h.html#291">fileContext</a> );</div><div id="423" class="line none">  423 </div><div id="424" class="line none">  424     topicStringParts[ 1 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#290">pThingName</a>;</div><div id="425" class="line none">  425     topicStringParts[ 3 ] = ( const char * ) pFileContext-&gt;<a href="include/ota.h.html#270">pStreamName</a>;</div><div id="426" class="line none">  426 </div><div id="427" class="line none">  427     /* Try to build the dynamic data stream topic and unsubscribe from it. */</div><div id="428" class="line none">  428     topicLen = ( uint16_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="429" class="line none">  429         pOtaRxStreamTopic,</div><div id="430" class="line none">  430         sizeof( pOtaRxStreamTopic ),</div><div id="431" class="line none">  431         topicStringParts );</div><div id="432" class="line none">  432 </div><div id="433" class="line none">  433     /* The buffer is static and the size is calculated to fit. */</div><div id="434" class="line none">  434     assert( ( topicLen &gt; 0U ) &amp;&amp; ( topicLen &lt; sizeof( pOtaRxStreamTopic ) ) );</div><div id="435" class="line none">  435 </div><div id="436" class="line none">  436     mqttStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#253">mqtt</a>.<a href="include/ota_mqtt_interface.h.html#158">unsubscribe</a>( pOtaRxStreamTopic,</div><div id="437" class="line none">  437                                                              topicLen,</div><div id="438" class="line none">  438                                                              1 );</div><div id="439" class="line none">  439 </div><div id="440" class="line none">  440     if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="441" class="line none">  441     {</div><div id="442" class="line none">  442         LogInfo( ( "Unsubscribed to MQTT topic: %s", pOtaRxStreamTopic ) );</div><div id="443" class="line none">  443     }</div><div id="444" class="line none">  444     else</div><div id="445" class="line none">  445     {</div><div id="446" class="line none">  446         LogError( ( "Failed to unsubscribe to MQTT topic: "</div><div id="447" class="line none">  447                     "unsubscribe returned error: "</div><div id="448" class="line none">  448                     "OtaMqttStatus_t=%s"</div><div id="449" class="line none">  449                     ", topic=%s",</div><div id="450" class="line none">  450                     <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ),</div><div id="451" class="line none">  451                     pOtaRxStreamTopic ) );</div><div id="452" class="line none">  452     }</div><div id="453" class="line none">  453 </div><div id="454" class="line none">  454     return mqttStatus;</div><div id="455" class="line none">  455 }</div><div id="456" class="line none">  456 </div><div id="457" class="line none">  457 /*</div><div id="458" class="line none">  458  * Unsubscribe from the OTA job notification topics.</div><div id="459" class="line none">  459  */</div><div id="460" class="line none">  460 static <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="ota_mqtt.c.html#460">unsubscribeFromJobNotificationTopic</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="461" class="line none">  461 {</div><div id="462" class="line none">  462     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="463" class="line none">  463 </div><div id="464" class="line none">  464     /* This buffer is used to store the generated MQTT topic. The static size</div><div id="465" class="line none">  465      * is calculated from the template and the corresponding parameters. This</div><div id="466" class="line none">  466      * buffer is used with two separate templates and its size is set fit the</div><div id="467" class="line none">  467      * larger of the two. */</div><div id="468" class="line none">  468     char pJobTopic[ <a href="ota_mqtt.c.html#132">TOPIC_NOTIFY_NEXT_BUFFER_SIZE</a> ];</div><div id="469" class="line none">  469     uint16_t topicLen = 0;</div><div id="470" class="line none">  470 </div><div id="471" class="line none">  471     /* NULL-terminated list of topic string parts. */</div><div id="472" class="line none">  472     const char * topicStringParts[] =</div><div id="473" class="line none">  473     {</div><div id="474" class="line none">  474         <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a>,</div><div id="475" class="line none">  475         NULL, /* Thing Name not available at compile time, initialized below. */</div><div id="476" class="line none">  476         <a href="ota_mqtt.c.html#58">MQTT_API_JOBS_NOTIFY_NEXT</a>,</div><div id="477" class="line none">  477         NULL</div><div id="478" class="line none">  478     };</div><div id="479" class="line none">  479 </div><div id="480" class="line none">  480     assert( pAgentCtx != NULL );</div><div id="481" class="line none">  481 </div><div id="482" class="line none">  482     /* Try to unsubscribe from the first of two job topics. */</div><div id="483" class="line none">  483 </div><div id="484" class="line none">  484     topicStringParts[ 1 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#290">pThingName</a>;</div><div id="485" class="line none">  485     topicLen = ( uint16_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="486" class="line none">  486         pJobTopic,</div><div id="487" class="line none">  487         sizeof( pJobTopic ),</div><div id="488" class="line none">  488         topicStringParts );</div><div id="489" class="line none">  489 </div><div id="490" class="line none">  490     /* The buffer is static and the size is calculated to fit. */</div><div id="491" class="line none">  491     assert( ( topicLen &gt; 0U ) &amp;&amp; ( topicLen &lt; sizeof( pJobTopic ) ) );</div><div id="492" class="line none">  492 </div><div id="493" class="line none">  493     mqttStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#253">mqtt</a>.<a href="include/ota_mqtt_interface.h.html#158">unsubscribe</a>( pJobTopic,</div><div id="494" class="line none">  494                                                              topicLen,</div><div id="495" class="line none">  495                                                              0 );</div><div id="496" class="line none">  496 </div><div id="497" class="line none">  497     if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="498" class="line none">  498     {</div><div id="499" class="line none">  499         LogInfo( ( "Unsubscribed to MQTT topic: %s", pJobTopic ) );</div><div id="500" class="line none">  500     }</div><div id="501" class="line none">  501     else</div><div id="502" class="line none">  502     {</div><div id="503" class="line none">  503         LogError( ( "Failed to unsubscribe to MQTT topic: "</div><div id="504" class="line none">  504                     "unsubscribe returned error: "</div><div id="505" class="line none">  505                     "OtaMqttStatus_t=%s"</div><div id="506" class="line none">  506                     ", topic=%s",</div><div id="507" class="line none">  507                     <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ),</div><div id="508" class="line none">  508                     pJobTopic ) );</div><div id="509" class="line none">  509     }</div><div id="510" class="line none">  510 </div><div id="511" class="line none">  511     return mqttStatus;</div><div id="512" class="line none">  512 }</div><div id="513" class="line none">  513 </div><div id="514" class="line none">  514 /*</div><div id="515" class="line none">  515  * Publish a message to the job status topic.</div><div id="516" class="line none">  516  */</div><div id="517" class="line none">  517 static <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="ota_mqtt.c.html#517">publishStatusMessage</a>( <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx,</div><div id="518" class="line none">  518                                              const char * pMsg,</div><div id="519" class="line none">  519                                              uint32_t msgSize,</div><div id="520" class="line none">  520                                              uint8_t qos )</div><div id="521" class="line none">  521 {</div><div id="522" class="line none">  522     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="523" class="line none">  523     size_t topicLen = 0;</div><div id="524" class="line none">  524 </div><div id="525" class="line none">  525     /* This buffer is used to store the generated MQTT topic. The static size</div><div id="526" class="line none">  526      * is calculated from the template and the corresponding parameters. */</div><div id="527" class="line none">  527     char pTopicBuffer[ <a href="ota_mqtt.c.html#133">TOPIC_JOB_STATUS_BUFFER_SIZE</a> ];</div><div id="528" class="line none">  528     /* NULL-terminated list of topic string parts. */</div><div id="529" class="line none">  529     const char * topicStringParts[] =</div><div id="530" class="line none">  530     {</div><div id="531" class="line none">  531         <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a>,</div><div id="532" class="line none">  532         NULL, /* Thing Name not available at compile time, initialized below. */</div><div id="533" class="line none">  533         <a href="ota_mqtt.c.html#59">MQTT_API_JOBS</a>,</div><div id="534" class="line none">  534         NULL, /* Active Job Name not available at compile time, initialized below. */</div><div id="535" class="line none">  535         <a href="ota_mqtt.c.html#60">MQTT_API_UPDATE</a>,</div><div id="536" class="line none">  536         NULL</div><div id="537" class="line none">  537     };</div><div id="538" class="line none">  538 </div><div id="539" class="line none">  539     assert( pAgentCtx != NULL );</div><div id="540" class="line none">  540     /* pMsg is a static buffer of size "OTA_STATUS_MSG_MAX_SIZE". */</div><div id="541" class="line none">  541     assert( pMsg != NULL );</div><div id="542" class="line none">  542 </div><div id="543" class="line none">  543     /* Build the dynamic job status topic . */</div><div id="544" class="line none">  544 </div><div id="545" class="line none">  545     topicStringParts[ 1 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#290">pThingName</a>;</div><div id="546" class="line none">  546     topicStringParts[ 3 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#294">pActiveJobName</a>;</div><div id="547" class="line none">  547 </div><div id="548" class="line none">  548     topicLen = <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="549" class="line none">  549         pTopicBuffer,</div><div id="550" class="line none">  550         sizeof( pTopicBuffer ),</div><div id="551" class="line none">  551         topicStringParts );</div><div id="552" class="line none">  552 </div><div id="553" class="line none">  553     /* The buffer is static and the size is calculated to fit. */</div><div id="554" class="line none">  554     assert( ( topicLen &gt; 0U ) &amp;&amp; ( topicLen &lt; sizeof( pTopicBuffer ) ) );</div><div id="555" class="line none">  555 </div><div id="556" class="line none">  556     /* Publish the status message. */</div><div id="557" class="line none">  557     LogDebug( ( "Attempting to publish MQTT status message: "</div><div id="558" class="line none">  558                 "message=%s",</div><div id="559" class="line none">  559                 pMsg ) );</div><div id="560" class="line none">  560 </div><div id="561" class="line none">  561     mqttStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#253">mqtt</a>.<a href="include/ota_mqtt_interface.h.html#159">publish</a>( pTopicBuffer,</div><div id="562" class="line none">  562                                                          ( uint16_t ) topicLen,</div><div id="563" class="line none">  563                                                          &amp;pMsg[ 0 ],</div><div id="564" class="line none">  564                                                          msgSize,</div><div id="565" class="line none">  565                                                          qos );</div><div id="566" class="line none">  566 </div><div id="567" class="line none">  567     if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="568" class="line none">  568     {</div><div id="569" class="line none">  569         LogDebug( ( "Published to MQTT topic: "</div><div id="570" class="line none">  570                     "topic=%s",</div><div id="571" class="line none">  571                     pTopicBuffer ) );</div><div id="572" class="line none">  572     }</div><div id="573" class="line none">  573     else</div><div id="574" class="line none">  574     {</div><div id="575" class="line none">  575         LogError( ( "Failed to publish MQTT message: "</div><div id="576" class="line none">  576                     "publish returned error: "</div><div id="577" class="line none">  577                     "OtaMqttStatus_t=%s"</div><div id="578" class="line none">  578                     ", topic=%s",</div><div id="579" class="line none">  579                     <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ),</div><div id="580" class="line none">  580                     pTopicBuffer ) );</div><div id="581" class="line none">  581     }</div><div id="582" class="line none">  582 </div><div id="583" class="line none">  583     return mqttStatus;</div><div id="584" class="line none">  584 }</div><div id="585" class="line none">  585 </div><div id="586" class="line none">  586 static uint32_t <a href="ota_mqtt.c.html#586">buildStatusMessageReceiving</a>( char * pMsgBuffer,</div><div id="587" class="line none">  587                                              size_t msgBufferSize,</div><div id="588" class="line none">  588                                              <a href="include/ota.h.html#184">OtaJobStatus_t</a> <a href="include/ota.h.html#202">status</a>,</div><div id="589" class="line none">  589                                              const <a href="include/ota_private.h.html#408">OtaFileContext_t</a> * pOTAFileCtx )</div><div id="590" class="line none">  590 {</div><div id="591" class="line none">  591     char receivedString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="592" class="line none">  592     char numBlocksString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="593" class="line none">  593     uint32_t numBlocks = 0;</div><div id="594" class="line none">  594     uint32_t received = 0;</div><div id="595" class="line none">  595     uint32_t msgSize = 0;</div><div id="596" class="line none">  596 </div><div id="597" class="line none">  597     /* NULL-terminated list of JSON payload components */</div><div id="598" class="line none">  598     /* NOTE: this must conform to the following format, do not add spaces, etc. */</div><div id="599" class="line none">  599     /*       "\"%s\":\"%u/%u\"}}" */</div><div id="600" class="line none">  600 </div><div id="601" class="line none">  601     const char * payloadStringParts[] =</div><div id="602" class="line none">  602     {</div><div id="603" class="line none">  603         NULL, /* Job status is not available at compile time, initialized below. */</div><div id="604" class="line none">  604         <a href="ota_mqtt.c.html#75">pOtaStringReceive</a>,</div><div id="605" class="line none">  605         ":\"",</div><div id="606" class="line none">  606         NULL, /* Received string is not available at compile time, initialized below. */</div><div id="607" class="line none">  607         "/",</div><div id="608" class="line none">  608         NULL, /* # blocks string is not available at compile time, initialized below. */</div><div id="609" class="line none">  609         "\"}}",</div><div id="610" class="line none">  610         NULL</div><div id="611" class="line none">  611     };</div><div id="612" class="line none">  612 </div><div id="613" class="line none">  613     assert( pMsgBuffer != NULL );</div><div id="614" class="line none">  614     /* This function is only called when a file is received, so it can't be NULL. */</div><div id="615" class="line none">  615     assert( pOTAFileCtx != NULL );</div><div id="616" class="line none">  616 </div><div id="617" class="line none">  617     numBlocks = ( pOTAFileCtx-&gt;<a href="include/ota_private.h.html#384">fileSize</a> + ( <a href="include/ota_private.h.html#56">OTA_FILE_BLOCK_SIZE</a> - 1U ) ) &gt;&gt; otaconfigLOG2_FILE_BLOCK_SIZE;</div><div id="618" class="line none">  618     received = numBlocks - pOTAFileCtx-&gt;<a href="include/ota_private.h.html#385">blocksRemaining</a>;</div><div id="619" class="line none">  619 </div><div id="620" class="line none">  620     /* Output a status update once in a while. */</div><div id="621" class="line none">  621     if( ( received % otaconfigOTA_UPDATE_STATUS_FREQUENCY ) == 0U )</div><div id="622" class="line none">  622     {</div><div id="623" class="line none">  623         payloadStringParts[ 0 ] = <a href="ota_mqtt.c.html#91">pOtaJobStatusStrings</a>[ <a href="include/ota.h.html#202">status</a> ];</div><div id="624" class="line none">  624         payloadStringParts[ 3 ] = receivedString;</div><div id="625" class="line none">  625         payloadStringParts[ 5 ] = numBlocksString;</div><div id="626" class="line none">  626 </div><div id="627" class="line none">  627         ( void ) <a href="ota_mqtt.c.html#281">stringBuilderUInt32Decimal</a>( receivedString, sizeof( receivedString ), received );</div><div id="628" class="line none">  628         ( void ) <a href="ota_mqtt.c.html#281">stringBuilderUInt32Decimal</a>( numBlocksString, sizeof( numBlocksString ), numBlocks );</div><div id="629" class="line none">  629 </div><div id="630" class="line none">  630 </div><div id="631" class="line none">  631         msgSize = ( uint32_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="632" class="line none">  632             pMsgBuffer,</div><div id="633" class="line none">  633             msgBufferSize,</div><div id="634" class="line none">  634             payloadStringParts );</div><div id="635" class="line none">  635 </div><div id="636" class="line none">  636         /* The buffer is static and the size is calculated to fit. */</div><div id="637" class="line none">  637         assert( ( msgSize &gt; 0U ) &amp;&amp; ( msgSize &lt; msgBufferSize ) );</div><div id="638" class="line none">  638     }</div><div id="639" class="line none">  639 </div><div id="640" class="line none">  640     return msgSize;</div><div id="641" class="line none">  641 }</div><div id="642" class="line none">  642 </div><div id="643" class="line none">  643 static uint32_t <a href="ota_mqtt.c.html#643">prvBuildStatusMessageSelfTest</a>( char * pMsgBuffer,</div><div id="644" class="line none">  644                                                size_t msgBufferSize,</div><div id="645" class="line none">  645                                                <a href="include/ota.h.html#184">OtaJobStatus_t</a> <a href="include/ota.h.html#202">status</a>,</div><div id="646" class="line none">  646                                                int32_t <a href="include/ota.h.html#203">reason</a> )</div><div id="647" class="line none">  647 {</div><div id="648" class="line none">  648     uint32_t msgSize = 0;</div><div id="649" class="line none">  649 </div><div id="650" class="line none">  650     /* NULL-terminated list of JSON payload components */</div><div id="651" class="line none">  651     /* NOTE: this must agree with the following format, do not add spaces, etc. */</div><div id="652" class="line none">  652     /*       "\"%s\":\"%s\",\"" OTA_JSON_UPDATED_BY_KEY_ONLY "\":\"0x%x\"}}" */</div><div id="653" class="line none">  653     char versionString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="654" class="line none">  654     const char * pPayloadStringParts[] =</div><div id="655" class="line none">  655     {</div><div id="656" class="line none">  656         NULL, /* Job status string not available at compile time, initialized below. */</div><div id="657" class="line none">  657         "\"",</div><div id="658" class="line none">  658         <a href="include/ota_private.h.html#138">OTA_JSON_SELF_TEST_KEY_ONLY</a>,</div><div id="659" class="line none">  659         "\":\"",</div><div id="660" class="line none">  660         NULL, /* Job reason string not available at compile time, initialized below. */</div><div id="661" class="line none">  661         "\",\"" <a href="include/ota_private.h.html#137">OTA_JSON_UPDATED_BY_KEY_ONLY</a> "\":\"0x",</div><div id="662" class="line none">  662         NULL, /* Version string not available at compile time, initialized below. */</div><div id="663" class="line none">  663         "\"}}",</div><div id="664" class="line none">  664         NULL</div><div id="665" class="line none">  665     };</div><div id="666" class="line none">  666 </div><div id="667" class="line none">  667     assert( pMsgBuffer != NULL );</div><div id="668" class="line none">  668 </div><div id="669" class="line none">  669     ( void ) <a href="ota_mqtt.c.html#310">stringBuilderUInt32Hex</a>( versionString, sizeof( versionString ), <a href="include/ota_appversion32.h.html#67">appFirmwareVersion</a>.<a href="include/ota_appversion32.h.html#64">u</a>.<a href="include/ota_appversion32.h.html#62">unsignedVersion32</a> );</div><div id="670" class="line none">  670     pPayloadStringParts[ 0 ] = <a href="ota_mqtt.c.html#91">pOtaJobStatusStrings</a>[ <a href="include/ota.h.html#202">status</a> ];</div><div id="671" class="line none">  671     pPayloadStringParts[ 4 ] = <a href="ota_mqtt.c.html#106">pOtaJobReasonStrings</a>[ <a href="include/ota.h.html#203">reason</a> ];</div><div id="672" class="line none">  672     pPayloadStringParts[ 6 ] = versionString;</div><div id="673" class="line none">  673 </div><div id="674" class="line none">  674     msgSize = ( uint32_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="675" class="line none">  675         pMsgBuffer,</div><div id="676" class="line none">  676         msgBufferSize,</div><div id="677" class="line none">  677         pPayloadStringParts );</div><div id="678" class="line none">  678 </div><div id="679" class="line none">  679     assert( ( msgSize &gt; 0U ) &amp;&amp; ( msgSize &lt; msgBufferSize ) );</div><div id="680" class="line none">  680 </div><div id="681" class="line none">  681     LogDebug( ( "Created self test update: %s", pMsgBuffer ) );</div><div id="682" class="line none">  682 </div><div id="683" class="line none">  683     return msgSize;</div><div id="684" class="line none">  684 }</div><div id="685" class="line none">  685 </div><div id="686" class="line none">  686 static uint32_t <a href="ota_mqtt.c.html#686">prvBuildStatusMessageFinish</a>( char * pMsgBuffer,</div><div id="687" class="line none">  687                                              size_t msgBufferSize,</div><div id="688" class="line none">  688                                              <a href="include/ota.h.html#184">OtaJobStatus_t</a> <a href="include/ota.h.html#202">status</a>,</div><div id="689" class="line none">  689                                              int32_t <a href="include/ota.h.html#203">reason</a>,</div><div id="690" class="line none">  690                                              int32_t <a href="include/ota.h.html#204">subReason</a> )</div><div id="691" class="line none">  691 {</div><div id="692" class="line none">  692     uint32_t msgSize = 0;</div><div id="693" class="line none">  693     char reasonString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="694" class="line none">  694     char subReasonString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="695" class="line none">  695     char versionMajorString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="696" class="line none">  696     char versionMinorString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="697" class="line none">  697     char versionBuildString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="698" class="line none">  698     <a href="include/ota_appversion32.h.html#65">AppVersion32_t</a> newVersion;</div><div id="699" class="line none">  699 </div><div id="700" class="line none">  700     /* NULL-terminated list of payload string parts */</div><div id="701" class="line none">  701     /* NOTE: this must conform to the following format, do not add spaces, etc. */</div><div id="702" class="line none">  702     /*       "\"reason\":\"0x%08x: 0x%08x\"}}" */</div><div id="703" class="line none">  703 </div><div id="704" class="line none">  704     const char * pPayloadPartsStatusFailedWithValue[] =</div><div id="705" class="line none">  705     {</div><div id="706" class="line none">  706         NULL, /* Job status string not available at compile time, initialized below. */</div><div id="707" class="line none">  707         "\"reason\":\"0x",</div><div id="708" class="line none">  708         NULL, /* Reason string not available at compile time, initialized below. */</div><div id="709" class="line none">  709         ": 0x",</div><div id="710" class="line none">  710         NULL, /* Sub-Reason string not available at compile time, initialized below. */</div><div id="711" class="line none">  711         "\"}}",</div><div id="712" class="line none">  712         NULL</div><div id="713" class="line none">  713     };</div><div id="714" class="line none">  714     /* NULL-terminated list of payload string parts */</div><div id="715" class="line none">  715     /* NOTE: this must agree with the following format, do not add spaces, etc. */</div><div id="716" class="line none">  716     /*       "\"reason\":\"%s v%u.%u.%u\"}}" */</div><div id="717" class="line none">  717     const char * pPayloadPartsStatusSucceeded[] =</div><div id="718" class="line none">  718     {</div><div id="719" class="line none">  719         NULL, /* Job status string not available at compile time, initialized below. */</div><div id="720" class="line none">  720         "\"reason\":\"",</div><div id="721" class="line none">  721         NULL, /*  Reason string not available at compile time, initialized below. */</div><div id="722" class="line none">  722         "  v",</div><div id="723" class="line none">  723         NULL, /* Version major string not available at compile time, initialized below. */</div><div id="724" class="line none">  724         ".",</div><div id="725" class="line none">  725         NULL, /* Version minor string not available at compile time, initialized below. */</div><div id="726" class="line none">  726         ".",</div><div id="727" class="line none">  727         NULL, /* Version build string not available at compile time, initialized below. */</div><div id="728" class="line none">  728         "\"}}",</div><div id="729" class="line none">  729         NULL</div><div id="730" class="line none">  730     };</div><div id="731" class="line none">  731 </div><div id="732" class="line none">  732     /* NULL-terminated list of payload string parts */</div><div id="733" class="line none">  733     /* NOTE: this must agree with the following format, do not add spaces, etc. */</div><div id="734" class="line none">  734     /*       "\"reason\":\"%s: 0x%08x\"}}" */</div><div id="735" class="line none">  735     const char * pPayloadPartsStatusOther[] =</div><div id="736" class="line none">  736     {</div><div id="737" class="line none">  737         NULL, /* Job status string not available at compile time, initialized below. */</div><div id="738" class="line none">  738         "\"reason\":\"",</div><div id="739" class="line none">  739         NULL, /*  Reason string not available at compile time, initialized below. */</div><div id="740" class="line none">  740         ": 0x",</div><div id="741" class="line none">  741         NULL, /* Sub-Reason string not available at compile time, initialized below. */</div><div id="742" class="line none">  742         "\"}}",</div><div id="743" class="line none">  743         NULL</div><div id="744" class="line none">  744     };</div><div id="745" class="line none">  745     const char ** pPayloadParts;</div><div id="746" class="line none">  746 </div><div id="747" class="line none">  747     assert( pMsgBuffer != NULL );</div><div id="748" class="line none">  748 </div><div id="749" class="line none">  749     newVersion.<a href="include/ota_appversion32.h.html#64">u</a>.<a href="include/ota_appversion32.h.html#63">signedVersion32</a> = <a href="include/ota.h.html#204">subReason</a>;</div><div id="750" class="line none">  750 </div><div id="751" class="line none">  751     ( void ) <a href="ota_mqtt.c.html#310">stringBuilderUInt32Hex</a>( reasonString, sizeof( reasonString ), ( uint32_t ) <a href="include/ota.h.html#203">reason</a> );</div><div id="752" class="line none">  752     ( void ) <a href="ota_mqtt.c.html#310">stringBuilderUInt32Hex</a>( subReasonString, sizeof( subReasonString ), ( uint32_t ) <a href="include/ota.h.html#204">subReason</a> );</div><div id="753" class="line none">  753     ( void ) <a href="ota_mqtt.c.html#281">stringBuilderUInt32Decimal</a>( versionMajorString, sizeof( versionMajorString ), newVersion.<a href="include/ota_appversion32.h.html#64">u</a>.<a href="include/ota_appversion32.h.html#50">x</a>.<a href="include/ota_appversion32.h.html#49">major</a> );</div><div id="754" class="line none">  754     ( void ) <a href="ota_mqtt.c.html#281">stringBuilderUInt32Decimal</a>( versionMinorString, sizeof( versionMinorString ), newVersion.<a href="include/ota_appversion32.h.html#64">u</a>.<a href="include/ota_appversion32.h.html#50">x</a>.<a href="include/ota_appversion32.h.html#47">minor</a> );</div><div id="755" class="line none">  755     ( void ) <a href="ota_mqtt.c.html#281">stringBuilderUInt32Decimal</a>( versionBuildString, sizeof( versionBuildString ), newVersion.<a href="include/ota_appversion32.h.html#64">u</a>.<a href="include/ota_appversion32.h.html#50">x</a>.<a href="include/ota_appversion32.h.html#46">build</a> );</div><div id="756" class="line none">  756 </div><div id="757" class="line none">  757     /* FailedWithVal uses a numeric OTA error code and sub-reason code to cover</div><div id="758" class="line none">  758      * the case where there may be too many description strings to reasonably</div><div id="759" class="line none">  759      * include in the code.</div><div id="760" class="line none">  760      */</div><div id="761" class="line none">  761     if( <a href="include/ota.h.html#202">status</a> == <a href="include/ota.h.html#182">JobStatusFailedWithVal</a> )</div><div id="762" class="line none">  762     {</div><div id="763" class="line none">  763         pPayloadParts = pPayloadPartsStatusFailedWithValue;</div><div id="764" class="line none">  764         pPayloadParts[ 0 ] = <a href="ota_mqtt.c.html#91">pOtaJobStatusStrings</a>[ <a href="include/ota.h.html#202">status</a> ];</div><div id="765" class="line none">  765         pPayloadParts[ 2 ] = reasonString;</div><div id="766" class="line none">  766         pPayloadParts[ 4 ] = subReasonString;</div><div id="767" class="line none">  767     }</div><div id="768" class="line none">  768 </div><div id="769" class="line none">  769     /* If the status update is for "Succeeded," we are identifying the version</div><div id="770" class="line none">  770      * of firmware that has been accepted. This makes it easy to find the</div><div id="771" class="line none">  771      * version associated with each device (Thing) when examining the OTA jobs</div><div id="772" class="line none">  772      * on the service side via the CLI or possibly with some console tool.</div><div id="773" class="line none">  773      */</div><div id="774" class="line none">  774     else if( <a href="include/ota.h.html#202">status</a> == <a href="include/ota.h.html#180">JobStatusSucceeded</a> )</div><div id="775" class="line none">  775     {</div><div id="776" class="line none">  776         pPayloadParts = pPayloadPartsStatusSucceeded;</div><div id="777" class="line none">  777         pPayloadParts[ 0 ] = <a href="ota_mqtt.c.html#91">pOtaJobStatusStrings</a>[ <a href="include/ota.h.html#202">status</a> ];</div><div id="778" class="line none">  778         pPayloadParts[ 2 ] = <a href="ota_mqtt.c.html#106">pOtaJobReasonStrings</a>[ <a href="include/ota.h.html#203">reason</a> ];</div><div id="779" class="line none">  779         pPayloadParts[ 4 ] = versionMajorString;</div><div id="780" class="line none">  780         pPayloadParts[ 6 ] = versionMinorString;</div><div id="781" class="line none">  781         pPayloadParts[ 8 ] = versionBuildString;</div><div id="782" class="line none">  782     }</div><div id="783" class="line none">  783     else</div><div id="784" class="line none">  784     {</div><div id="785" class="line none">  785         pPayloadParts = pPayloadPartsStatusOther;</div><div id="786" class="line none">  786         pPayloadParts[ 0 ] = <a href="ota_mqtt.c.html#91">pOtaJobStatusStrings</a>[ <a href="include/ota.h.html#202">status</a> ];</div><div id="787" class="line none">  787         pPayloadParts[ 2 ] = <a href="ota_mqtt.c.html#106">pOtaJobReasonStrings</a>[ <a href="include/ota.h.html#203">reason</a> ];</div><div id="788" class="line none">  788         pPayloadParts[ 4 ] = subReasonString;</div><div id="789" class="line none">  789     }</div><div id="790" class="line none">  790 </div><div id="791" class="line none">  791     msgSize = ( uint32_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="792" class="line none">  792         pMsgBuffer,</div><div id="793" class="line none">  793         msgBufferSize,</div><div id="794" class="line none">  794         pPayloadParts );</div><div id="795" class="line none">  795 </div><div id="796" class="line none">  796     /* The buffer is static and the size is calculated to fit. */</div><div id="797" class="line none">  797     assert( ( msgSize &gt; 0U ) &amp;&amp; ( msgSize &lt; msgBufferSize ) );</div><div id="798" class="line none">  798 </div><div id="799" class="line none">  799     return msgSize;</div><div id="800" class="line none">  800 }</div><div id="801" class="line none">  801 </div><div id="802" class="line none">  802 /*</div><div id="803" class="line none">  803  * Check for next available OTA job from the job service by publishing</div><div id="804" class="line none">  804  * a "get next job" message to the job service.</div><div id="805" class="line none">  805  */</div><div id="806" class="line none">  806 </div><div id="807" class="line none">  807 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_mqtt.c.html#807">requestJob_Mqtt</a>( <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="808" class="line none">  808 {</div><div id="809" class="line none">  809     /* This buffer is used to store the generated MQTT topic. The static size</div><div id="810" class="line none">  810      * is calculated from the template and the corresponding parameters. */</div><div id="811" class="line none">  811     char pJobTopic[ <a href="ota_mqtt.c.html#131">TOPIC_GET_NEXT_BUFFER_SIZE</a> ];</div><div id="812" class="line none">  812 </div><div id="813" class="line none">  813     /* The following buffer is big enough to hold a dynamically constructed</div><div id="814" class="line none">  814      * $next/get job message. It contains a client token that is used to track</div><div id="815" class="line none">  815      * how many requests have been made. */</div><div id="816" class="line none">  816     char pMsg[ <a href="ota_mqtt.c.html#136">MSG_GET_NEXT_BUFFER_SIZE</a> ];</div><div id="817" class="line none">  817 </div><div id="818" class="line none">  818     static uint32_t reqCounter = 0;</div><div id="819" class="line none">  819     <a href="include/ota.h.html#97">OtaErr_t</a> otaError = <a href="include/ota.h.html#80">OtaErrRequestJobFailed</a>;</div><div id="820" class="line none">  820     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="821" class="line none">  821     uint32_t msgSize = 0;</div><div id="822" class="line none">  822     uint16_t topicLen = 0;</div><div id="823" class="line none">  823 </div><div id="824" class="line none">  824     /* NULL-terminated list of topic string parts. */</div><div id="825" class="line none">  825     const char * pTopicParts[] =</div><div id="826" class="line none">  826     {</div><div id="827" class="line none">  827         <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a>,</div><div id="828" class="line none">  828         NULL, /* Thing Name not available at compile time, initialized below. */</div><div id="829" class="line none">  829         <a href="ota_mqtt.c.html#57">MQTT_API_JOBS_NEXT_GET</a>,</div><div id="830" class="line none">  830         NULL</div><div id="831" class="line none">  831     };</div><div id="832" class="line none">  832     char reqCounterString[ <a href="ota_mqtt.c.html#122">U32_MAX_LEN</a> + 1 ];</div><div id="833" class="line none">  833     /* NULL-terminated list of payload parts */</div><div id="834" class="line none">  834     /* NOTE: this must agree with pOtaGetNextJobMsgTemplate, do not add spaces, etc. */</div><div id="835" class="line none">  835     const char * pPayloadParts[] =</div><div id="836" class="line none">  836     {</div><div id="837" class="line none">  837         "{\"clientToken\":\"",</div><div id="838" class="line none">  838         NULL, /* Request counter string not available at compile time, initialized below. */</div><div id="839" class="line none">  839         ":",</div><div id="840" class="line none">  840         NULL, /* Thing Name not available at compile time, initialized below. */</div><div id="841" class="line none">  841         "\"}",</div><div id="842" class="line none">  842         NULL</div><div id="843" class="line none">  843     };</div><div id="844" class="line none">  844 </div><div id="845" class="line none">  845     assert( pAgentCtx != NULL );</div><div id="846" class="line none">  846 </div><div id="847" class="line none">  847     pTopicParts[ 1 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#290">pThingName</a>;</div><div id="848" class="line none">  848     pPayloadParts[ 1 ] = reqCounterString;</div><div id="849" class="line none">  849     pPayloadParts[ 3 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#290">pThingName</a>;</div><div id="850" class="line none">  850 </div><div id="851" class="line none">  851     ( void ) <a href="ota_mqtt.c.html#281">stringBuilderUInt32Decimal</a>( reqCounterString, sizeof( reqCounterString ), reqCounter );</div><div id="852" class="line none">  852 </div><div id="853" class="line none">  853     /* Subscribe to the OTA job notification topic. */</div><div id="854" class="line none">  854     mqttStatus = <a href="ota_mqtt.c.html#344">subscribeToJobNotificationTopics</a>( pAgentCtx );</div><div id="855" class="line none">  855 </div><div id="856" class="line none">  856     if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="857" class="line none">  857     {</div><div id="858" class="line none">  858         LogDebug( ( "MQTT job request number: counter=%u", reqCounter ) );</div><div id="859" class="line none">  859 </div><div id="860" class="line none">  860         msgSize = ( uint32_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="861" class="line none">  861             pMsg,</div><div id="862" class="line none">  862             sizeof( pMsg ),</div><div id="863" class="line none">  863             pPayloadParts );</div><div id="864" class="line none">  864 </div><div id="865" class="line none">  865         /* The buffer is static and the size is calculated to fit. */</div><div id="866" class="line none">  866         assert( ( msgSize &gt; 0U ) &amp;&amp; ( msgSize &lt; sizeof( pMsg ) ) );</div><div id="867" class="line none">  867 </div><div id="868" class="line none">  868         reqCounter++;</div><div id="869" class="line none">  869 </div><div id="870" class="line none">  870         topicLen = ( uint16_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="871" class="line none">  871             pJobTopic,</div><div id="872" class="line none">  872             sizeof( pJobTopic ),</div><div id="873" class="line none">  873             pTopicParts );</div><div id="874" class="line none">  874 </div><div id="875" class="line none">  875         /* The buffer is static and the size is calculated to fit. */</div><div id="876" class="line none">  876         assert( ( topicLen &gt; 0U ) &amp;&amp; ( topicLen &lt; sizeof( pJobTopic ) ) );</div><div id="877" class="line none">  877 </div><div id="878" class="line none">  878         mqttStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#253">mqtt</a>.<a href="include/ota_mqtt_interface.h.html#159">publish</a>( pJobTopic, topicLen, pMsg, msgSize, 1 );</div><div id="879" class="line none">  879 </div><div id="880" class="line none">  880         if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="881" class="line none">  881         {</div><div id="882" class="line none">  882             LogDebug( ( "Published MQTT request to get the next job: "</div><div id="883" class="line none">  883                         "topic=%s",</div><div id="884" class="line none">  884                         pJobTopic ) );</div><div id="885" class="line none">  885             otaError = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="886" class="line none">  886         }</div><div id="887" class="line none">  887         else</div><div id="888" class="line none">  888         {</div><div id="889" class="line none">  889             LogError( ( "Failed to publish MQTT message:"</div><div id="890" class="line none">  890                         "publish returned error: "</div><div id="891" class="line none">  891                         "OtaMqttStatus_t=%s",</div><div id="892" class="line none">  892                         <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ) ) );</div><div id="893" class="line none">  893         }</div><div id="894" class="line none">  894     }</div><div id="895" class="line none">  895 </div><div id="896" class="line none">  896     return otaError;</div><div id="897" class="line none">  897 }</div><div id="898" class="line none">  898 </div><div id="899" class="line none">  899 </div><div id="900" class="line none">  900 /*</div><div id="901" class="line none">  901  * Update the job status on the service side with progress or completion info.</div><div id="902" class="line none">  902  */</div><div id="903" class="line none">  903 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_mqtt.c.html#903">updateJobStatus_Mqtt</a>( <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx,</div><div id="904" class="line none">  904                                <a href="include/ota.h.html#184">OtaJobStatus_t</a> <a href="include/ota.h.html#202">status</a>,</div><div id="905" class="line none">  905                                int32_t <a href="include/ota.h.html#203">reason</a>,</div><div id="906" class="line none">  906                                int32_t <a href="include/ota.h.html#204">subReason</a> )</div><div id="907" class="line none">  907 {</div><div id="908" class="line none">  908     <a href="include/ota.h.html#97">OtaErr_t</a> result = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="909" class="line none">  909     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#84">OtaMqttPublishFailed</a>;</div><div id="910" class="line none">  910     /* A message size of zero means don't publish anything. */</div><div id="911" class="line none">  911     uint32_t msgSize = 0U;</div><div id="912" class="line none">  912     /* All job state transitions except streaming progress use QOS 1 since it is required to have status in the job document. */</div><div id="913" class="line none">  913     char pMsg[ <a href="ota_mqtt.c.html#49">OTA_STATUS_MSG_MAX_SIZE</a> ];</div><div id="914" class="line none">  914     uint8_t qos = 1;</div><div id="915" class="line none">  915     const <a href="include/ota_private.h.html#408">OtaFileContext_t</a> * pFileContext = NULL;</div><div id="916" class="line none">  916 </div><div id="917" class="line none">  917     assert( pAgentCtx != NULL );</div><div id="918" class="line none">  918 </div><div id="919" class="line none">  919     /* Get the current file context. */</div><div id="920" class="line none">  920     pFileContext = &amp;( pAgentCtx-&gt;<a href="include/ota.h.html#291">fileContext</a> );</div><div id="921" class="line none">  921 </div><div id="922" class="line none">  922     if( <a href="include/ota.h.html#202">status</a> == <a href="include/ota.h.html#178">JobStatusInProgress</a> )</div><div id="923" class="line none">  923     {</div><div id="924" class="line none">  924         if( <a href="include/ota.h.html#203">reason</a> == ( int32_t ) <a href="include/ota_private.h.html#228">JobReasonReceiving</a> )</div><div id="925" class="line none">  925         {</div><div id="926" class="line none">  926             msgSize = <a href="ota_mqtt.c.html#586">buildStatusMessageReceiving</a>( pMsg, sizeof( pMsg ), <a href="include/ota.h.html#202">status</a>, pFileContext );</div><div id="927" class="line none">  927 </div><div id="928" class="line none">  928             /* Downgrade Progress updates to QOS 0 to avoid overloading MQTT buffers during active streaming. */</div><div id="929" class="line none">  929             qos = 0;</div><div id="930" class="line none">  930         }</div><div id="931" class="line none">  931         else</div><div id="932" class="line none">  932         {</div><div id="933" class="line none">  933             /* We're no longer receiving but we're still In Progress so we are implicitly in the Self</div><div id="934" class="line none">  934              * Test phase. Prepare to update the job status with the self_test phase (ready or active). */</div><div id="935" class="line none">  935             msgSize = <a href="ota_mqtt.c.html#643">prvBuildStatusMessageSelfTest</a>( pMsg, sizeof( pMsg ), <a href="include/ota.h.html#202">status</a>, <a href="include/ota.h.html#203">reason</a> );</div><div id="936" class="line none">  936         }</div><div id="937" class="line none">  937     }</div><div id="938" class="line none">  938     else</div><div id="939" class="line none">  939     {</div><div id="940" class="line none">  940         /* The potential values for status are constant at compile time. */</div><div id="941" class="line none">  941         assert( <a href="include/ota.h.html#202">status</a> &lt; <a href="include/ota.h.html#183">NumJobStatusMappings</a> );</div><div id="942" class="line none">  942         msgSize = <a href="ota_mqtt.c.html#686">prvBuildStatusMessageFinish</a>( pMsg, sizeof( pMsg ), <a href="include/ota.h.html#202">status</a>, <a href="include/ota.h.html#203">reason</a>, <a href="include/ota.h.html#204">subReason</a> );</div><div id="943" class="line none">  943     }</div><div id="944" class="line none">  944 </div><div id="945" class="line none">  945     if( msgSize &gt; 0U )</div><div id="946" class="line none">  946     {</div><div id="947" class="line none">  947         /* Publish the string created above. */</div><div id="948" class="line none">  948         mqttStatus = <a href="ota_mqtt.c.html#517">publishStatusMessage</a>( pAgentCtx, pMsg, msgSize, qos );</div><div id="949" class="line none">  949 </div><div id="950" class="line none">  950         if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="951" class="line none">  951         {</div><div id="952" class="line none">  952             LogDebug( ( "Published update to the job status." ) );</div><div id="953" class="line none">  953         }</div><div id="954" class="line none">  954         else</div><div id="955" class="line none">  955         {</div><div id="956" class="line none">  956             LogError( ( "Failed to publish MQTT status message: "</div><div id="957" class="line none">  957                         "publishStatusMessage returned error: "</div><div id="958" class="line none">  958                         "OtaMqttStatus_t=%s",</div><div id="959" class="line none">  959                         <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ) ) );</div><div id="960" class="line none">  960 </div><div id="961" class="line none">  961             result = <a href="include/ota.h.html#85">OtaErrUpdateJobStatusFailed</a>;</div><div id="962" class="line none">  962         }</div><div id="963" class="line none">  963     }</div><div id="964" class="line none">  964 </div><div id="965" class="line none">  965     return result;</div><div id="966" class="line none">  966 }</div><div id="967" class="line none">  967 </div><div id="968" class="line none">  968 /*</div><div id="969" class="line none">  969  * Init file transfer by subscribing to the OTA data stream topic.</div><div id="970" class="line none">  970  */</div><div id="971" class="line none">  971 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_mqtt.c.html#971">initFileTransfer_Mqtt</a>( <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="972" class="line none">  972 {</div><div id="973" class="line none">  973     <a href="include/ota.h.html#97">OtaErr_t</a> result = <a href="include/ota.h.html#81">OtaErrInitFileTransferFailed</a>;</div><div id="974" class="line none">  974     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="975" class="line none">  975 </div><div id="976" class="line none">  976     /* This buffer is used to store the generated MQTT topic. The static size</div><div id="977" class="line none">  977      * is calculated from the template and the corresponding parameters. */</div><div id="978" class="line none">  978     static char pRxStreamTopic[ <a href="ota_mqtt.c.html#134">TOPIC_STREAM_DATA_BUFFER_SIZE</a> ]; /*!&lt; Buffer to store the topic generated for requesting data stream. */</div><div id="979" class="line none">  979     uint16_t topicLen = 0;</div><div id="980" class="line none">  980     const <a href="include/ota_private.h.html#408">OtaFileContext_t</a> * pFileContext = NULL;</div><div id="981" class="line none">  981 </div><div id="982" class="line none">  982     /* NULL-terminated list of topic string parts. */</div><div id="983" class="line none">  983     const char * pTopicParts[] =</div><div id="984" class="line none">  984     {</div><div id="985" class="line none">  985         <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a>,</div><div id="986" class="line none">  986         NULL, /* Thing Name not available at compile time, initialized below. */</div><div id="987" class="line none">  987         <a href="ota_mqtt.c.html#61">MQTT_API_STREAMS</a>,</div><div id="988" class="line none">  988         NULL, /* Stream Name not available at compile time, initialized below. */</div><div id="989" class="line none">  989         <a href="ota_mqtt.c.html#62">MQTT_API_DATA_CBOR</a>,</div><div id="990" class="line none">  990         NULL</div><div id="991" class="line none">  991     };</div><div id="992" class="line none">  992 </div><div id="993" class="line none">  993     assert( pAgentCtx != NULL );</div><div id="994" class="line none">  994 </div><div id="995" class="line none">  995     pFileContext = &amp;( pAgentCtx-&gt;<a href="include/ota.h.html#291">fileContext</a> );</div><div id="996" class="line none">  996     pTopicParts[ 1 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#290">pThingName</a>;</div><div id="997" class="line none">  997     pTopicParts[ 3 ] = ( const char * ) pFileContext-&gt;<a href="include/ota.h.html#270">pStreamName</a>;</div><div id="998" class="line none">  998 </div><div id="999" class="line none">  999     topicLen = ( uint16_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="1000" class="line none"> 1000         pRxStreamTopic,</div><div id="1001" class="line none"> 1001         sizeof( pRxStreamTopic ),</div><div id="1002" class="line none"> 1002         pTopicParts );</div><div id="1003" class="line none"> 1003 </div><div id="1004" class="line none"> 1004     /* The buffer is static and the size is calculated to fit. */</div><div id="1005" class="line none"> 1005     assert( ( topicLen &gt; 0U ) &amp;&amp; ( topicLen &lt; sizeof( pRxStreamTopic ) ) );</div><div id="1006" class="line none"> 1006 </div><div id="1007" class="line none"> 1007     mqttStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#253">mqtt</a>.<a href="include/ota_mqtt_interface.h.html#157">subscribe</a>( pRxStreamTopic,</div><div id="1008" class="line none"> 1008                                                            topicLen,</div><div id="1009" class="line none"> 1009                                                            0 );</div><div id="1010" class="line none"> 1010 </div><div id="1011" class="line none"> 1011     if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="1012" class="line none"> 1012     {</div><div id="1013" class="line none"> 1013         LogDebug( ( "Subscribed to the OTA data stream topic: "</div><div id="1014" class="line none"> 1014                     "topic=%s",</div><div id="1015" class="line none"> 1015                     pRxStreamTopic ) );</div><div id="1016" class="line none"> 1016         result = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="1017" class="line none"> 1017     }</div><div id="1018" class="line none"> 1018     else</div><div id="1019" class="line none"> 1019     {</div><div id="1020" class="line none"> 1020         LogError( ( "Failed to subscribe to MQTT topic: "</div><div id="1021" class="line none"> 1021                     "subscribe returned error: "</div><div id="1022" class="line none"> 1022                     "OtaMqttStatus_t=%s"</div><div id="1023" class="line none"> 1023                     ", topic=%s",</div><div id="1024" class="line none"> 1024                     <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ),</div><div id="1025" class="line none"> 1025                     pRxStreamTopic ) );</div><div id="1026" class="line none"> 1026     }</div><div id="1027" class="line none"> 1027 </div><div id="1028" class="line none"> 1028     return result;</div><div id="1029" class="line none"> 1029 }</div><div id="1030" class="line none"> 1030 </div><div id="1031" class="line none"> 1031 /*</div><div id="1032" class="line none"> 1032  * Request file block by publishing to the get stream topic.</div><div id="1033" class="line none"> 1033  */</div><div id="1034" class="line none"> 1034 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_mqtt.c.html#1034">requestFileBlock_Mqtt</a>( <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="1035" class="line none"> 1035 {</div><div id="1036" class="line none"> 1036     <a href="include/ota.h.html#97">OtaErr_t</a> result = <a href="include/ota.h.html#82">OtaErrRequestFileBlockFailed</a>;</div><div id="1037" class="line none"> 1037     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="1038" class="line none"> 1038     size_t msgSizeFromStream = 0;</div><div id="1039" class="line none"> 1039     uint32_t blockSize = <a href="include/ota_private.h.html#56">OTA_FILE_BLOCK_SIZE</a>;</div><div id="1040" class="line none"> 1040     uint32_t numBlocks = 0;</div><div id="1041" class="line none"> 1041     uint32_t bitmapLen = 0;</div><div id="1042" class="line none"> 1042     uint32_t msgSizeToPublish = 0;</div><div id="1043" class="line none"> 1043     uint32_t topicLen = 0;</div><div id="1044" class="line none"> 1044     bool cborEncodeRet = false;</div><div id="1045" class="line none"> 1045     char pMsg[ <a href="include/ota_private.h.html#59">OTA_REQUEST_MSG_MAX_SIZE</a> ];</div><div id="1046" class="line none"> 1046 </div><div id="1047" class="line none"> 1047     /* This buffer is used to store the generated MQTT topic. The static size</div><div id="1048" class="line none"> 1048      * is calculated from the template and the corresponding parameters. */</div><div id="1049" class="line none"> 1049     char pTopicBuffer[ <a href="ota_mqtt.c.html#135">TOPIC_GET_STREAM_BUFFER_SIZE</a> ];</div><div id="1050" class="line none"> 1050     const <a href="include/ota_private.h.html#408">OtaFileContext_t</a> * pFileContext = NULL;</div><div id="1051" class="line none"> 1051 </div><div id="1052" class="line none"> 1052     /* NULL-terminated list of topic string parts. */</div><div id="1053" class="line none"> 1053     const char * pTopicParts[] =</div><div id="1054" class="line none"> 1054     {</div><div id="1055" class="line none"> 1055         <a href="ota_mqtt.c.html#56">MQTT_API_THINGS</a>,</div><div id="1056" class="line none"> 1056         NULL, /* Thing Name not available at compile time, initialized below. */</div><div id="1057" class="line none"> 1057         <a href="ota_mqtt.c.html#61">MQTT_API_STREAMS</a>,</div><div id="1058" class="line none"> 1058         NULL, /* Stream Name not available at compile time, initialized below. */</div><div id="1059" class="line none"> 1059         <a href="ota_mqtt.c.html#63">MQTT_API_GET_CBOR</a>,</div><div id="1060" class="line none"> 1060         NULL</div><div id="1061" class="line none"> 1061     };</div><div id="1062" class="line none"> 1062 </div><div id="1063" class="line none"> 1063     assert( pAgentCtx != NULL );</div><div id="1064" class="line none"> 1064 </div><div id="1065" class="line none"> 1065     /* Get the current file context. */</div><div id="1066" class="line none"> 1066     pFileContext = &amp;( pAgentCtx-&gt;<a href="include/ota.h.html#291">fileContext</a> );</div><div id="1067" class="line none"> 1067 </div><div id="1068" class="line none"> 1068     pTopicParts[ 1 ] = ( const char * ) pAgentCtx-&gt;<a href="include/ota.h.html#290">pThingName</a>;</div><div id="1069" class="line none"> 1069     pTopicParts[ 3 ] = ( const char * ) pFileContext-&gt;<a href="include/ota.h.html#270">pStreamName</a>;</div><div id="1070" class="line none"> 1070 </div><div id="1071" class="line none"> 1071     /* Reset number of blocks requested. */</div><div id="1072" class="line none"> 1072     pAgentCtx-&gt;<a href="include/ota.h.html#298">numOfBlocksToReceive</a> = otaconfigMAX_NUM_BLOCKS_REQUEST;</div><div id="1073" class="line none"> 1073 </div><div id="1074" class="line none"> 1074     numBlocks = ( pFileContext-&gt;<a href="include/ota_private.h.html#384">fileSize</a> + ( <a href="include/ota_private.h.html#56">OTA_FILE_BLOCK_SIZE</a> - 1U ) ) &gt;&gt; otaconfigLOG2_FILE_BLOCK_SIZE;</div><div id="1075" class="line none"> 1075     bitmapLen = ( numBlocks + ( <a href="include/ota_private.h.html#55">BITS_PER_BYTE</a> - 1U ) ) &gt;&gt; <a href="include/ota_private.h.html#54">LOG2_BITS_PER_BYTE</a>;</div><div id="1076" class="line none"> 1076 </div><div id="1077" class="line none"> 1077     cborEncodeRet = <a href="include/ota_cbor_private.h.html#64">OTA_CBOR_Encode_GetStreamRequestMessage</a>( ( uint8_t * ) pMsg,</div><div id="1078" class="line none"> 1078                                                              sizeof( pMsg ),</div><div id="1079" class="line none"> 1079                                                              &amp;msgSizeFromStream,</div><div id="1080" class="line none"> 1080                                                              <a href="ota_mqtt.c.html#46">OTA_CLIENT_TOKEN</a>,</div><div id="1081" class="line none"> 1081                                                              ( int32_t ) pFileContext-&gt;<a href="include/ota.h.html#293">serverFileID</a>,</div><div id="1082" class="line none"> 1082                                                              ( int32_t ) blockSize,</div><div id="1083" class="line none"> 1083                                                              0,</div><div id="1084" class="line none"> 1084                                                              pFileContext-&gt;<a href="include/ota_private.h.html#392">pRxBlockBitmap</a>,</div><div id="1085" class="line none"> 1085                                                              bitmapLen,</div><div id="1086" class="line none"> 1086                                                              ( int32_t ) otaconfigMAX_NUM_BLOCKS_REQUEST );</div><div id="1087" class="line none"> 1087 </div><div id="1088" class="line none"> 1088     if( cborEncodeRet == true )</div><div id="1089" class="line none"> 1089     {</div><div id="1090" class="line none"> 1090         msgSizeToPublish = ( uint32_t ) msgSizeFromStream;</div><div id="1091" class="line none"> 1091 </div><div id="1092" class="line none"> 1092         /* Try to build the dynamic data REQUEST topic to publish to. */</div><div id="1093" class="line none"> 1093 </div><div id="1094" class="line none"> 1094         topicLen = ( uint32_t ) <a href="ota_mqtt.c.html#256">stringBuilder</a>(</div><div id="1095" class="line none"> 1095             pTopicBuffer,</div><div id="1096" class="line none"> 1096             sizeof( pTopicBuffer ),</div><div id="1097" class="line none"> 1097             pTopicParts );</div><div id="1098" class="line none"> 1098 </div><div id="1099" class="line none"> 1099         /* The buffer is static and the size is calculated to fit. */</div><div id="1100" class="line none"> 1100         assert( ( topicLen &gt; 0U ) &amp;&amp; ( topicLen &lt; sizeof( pTopicBuffer ) ) );</div><div id="1101" class="line none"> 1101 </div><div id="1102" class="line none"> 1102         mqttStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#253">mqtt</a>.<a href="include/ota_mqtt_interface.h.html#159">publish</a>( pTopicBuffer,</div><div id="1103" class="line none"> 1103                                                              ( uint16_t ) topicLen,</div><div id="1104" class="line none"> 1104                                                              &amp;pMsg[ 0 ],</div><div id="1105" class="line none"> 1105                                                              msgSizeToPublish,</div><div id="1106" class="line none"> 1106                                                              0 );</div><div id="1107" class="line none"> 1107 </div><div id="1108" class="line none"> 1108         if( mqttStatus == <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="1109" class="line none"> 1109         {</div><div id="1110" class="line none"> 1110             LogInfo( ( "Published to MQTT topic to request the next block: "</div><div id="1111" class="line none"> 1111                        "topic=%s",</div><div id="1112" class="line none"> 1112                        pTopicBuffer ) );</div><div id="1113" class="line none"> 1113             result = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="1114" class="line none"> 1114         }</div><div id="1115" class="line none"> 1115         else</div><div id="1116" class="line none"> 1116         {</div><div id="1117" class="line none"> 1117             LogError( ( "Failed to publish MQTT message: "</div><div id="1118" class="line none"> 1118                         "publish returned error: "</div><div id="1119" class="line none"> 1119                         "OtaMqttStatus_t=%s",</div><div id="1120" class="line none"> 1120                         <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ) ) );</div><div id="1121" class="line none"> 1121         }</div><div id="1122" class="line none"> 1122     }</div><div id="1123" class="line none"> 1123     else</div><div id="1124" class="line none"> 1124     {</div><div id="1125" class="line none"> 1125         result = <a href="include/ota.h.html#94">OtaErrFailedToEncodeCbor</a>;</div><div id="1126" class="line none"> 1126         LogError( ( "Failed to CBOR encode stream request message: "</div><div id="1127" class="line none"> 1127                     "OTA_CBOR_Encode_GetStreamRequestMessage returned error." ) );</div><div id="1128" class="line none"> 1128     }</div><div id="1129" class="line none"> 1129 </div><div id="1130" class="line none"> 1130     return result;</div><div id="1131" class="line none"> 1131 }</div><div id="1132" class="line none"> 1132 </div><div id="1133" class="line none"> 1133 /*</div><div id="1134" class="line none"> 1134  * Decode a cbor encoded fileblock received from streaming service.</div><div id="1135" class="line none"> 1135  */</div><div id="1136" class="line none"> 1136 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_mqtt.c.html#1136">decodeFileBlock_Mqtt</a>( const uint8_t * pMessageBuffer,</div><div id="1137" class="line none"> 1137                                size_t messageSize,</div><div id="1138" class="line none"> 1138                                int32_t * pFileId,</div><div id="1139" class="line none"> 1139                                int32_t * pBlockId,</div><div id="1140" class="line none"> 1140                                int32_t * pBlockSize,</div><div id="1141" class="line none"> 1141                                uint8_t ** pPayload,</div><div id="1142" class="line none"> 1142                                size_t * pPayloadSize )</div><div id="1143" class="line none"> 1143 {</div><div id="1144" class="line none"> 1144     <a href="include/ota.h.html#97">OtaErr_t</a> result = <a href="include/ota.h.html#95">OtaErrFailedToDecodeCbor</a>;</div><div id="1145" class="line none"> 1145     bool cborDecodeRet = false;</div><div id="1146" class="line none"> 1146 </div><div id="1147" class="line none"> 1147     /* Decode the CBOR content. */</div><div id="1148" class="line none"> 1148     cborDecodeRet = <a href="include/ota_cbor_private.h.html#51">OTA_CBOR_Decode_GetStreamResponseMessage</a>( pMessageBuffer,</div><div id="1149" class="line none"> 1149                                                               messageSize,</div><div id="1150" class="line none"> 1150                                                               pFileId,</div><div id="1151" class="line none"> 1151                                                               pBlockId,   /* CBOR requires pointer to int and our block indices never exceed 31 bits. */</div><div id="1152" class="line none"> 1152                                                               pBlockSize, /* CBOR requires pointer to int and our block sizes never exceed 31 bits. */</div><div id="1153" class="line none"> 1153                                                               pPayload,   /* This payload gets malloc'd by OTA_CBOR_Decode_GetStreamResponseMessage(). We must free it. */</div><div id="1154" class="line none"> 1154                                                               pPayloadSize );</div><div id="1155" class="line none"> 1155 </div><div id="1156" class="line none"> 1156     if( cborDecodeRet == true )</div><div id="1157" class="line none"> 1157     {</div><div id="1158" class="line none"> 1158         /* pPayload and pPayloadSize is allocated by the caller. */</div><div id="1159" class="line none"> 1159         assert( ( pPayload != NULL ) &amp;&amp; ( pPayloadSize != NULL ) );</div><div id="1160" class="line none"> 1160 </div><div id="1161" class="line none"> 1161         result = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="1162" class="line none"> 1162     }</div><div id="1163" class="line none"> 1163     else</div><div id="1164" class="line none"> 1164     {</div><div id="1165" class="line none"> 1165         LogError( ( "Failed to decode MQTT file block: "</div><div id="1166" class="line none"> 1166                     "OTA_CBOR_Decode_GetStreamResponseMessage returned error." ) );</div><div id="1167" class="line none"> 1167     }</div><div id="1168" class="line none"> 1168 </div><div id="1169" class="line none"> 1169     return result;</div><div id="1170" class="line none"> 1170 }</div><div id="1171" class="line none"> 1171 </div><div id="1172" class="line none"> 1172 /*</div><div id="1173" class="line none"> 1173  * Perform any cleanup operations required for control plane.</div><div id="1174" class="line none"> 1174  */</div><div id="1175" class="line none"> 1175 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_mqtt.c.html#1175">cleanupControl_Mqtt</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="1176" class="line none"> 1176 {</div><div id="1177" class="line none"> 1177     <a href="include/ota.h.html#97">OtaErr_t</a> result = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="1178" class="line none"> 1178     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="1179" class="line none"> 1179 </div><div id="1180" class="line none"> 1180     assert( pAgentCtx != NULL );</div><div id="1181" class="line none"> 1181 </div><div id="1182" class="line none"> 1182     if( pAgentCtx-&gt;<a href="include/ota.h.html#303">unsubscribeOnShutdown</a> != 0U )</div><div id="1183" class="line none"> 1183     {</div><div id="1184" class="line none"> 1184         /* Unsubscribe from job notification topics. */</div><div id="1185" class="line none"> 1185         mqttStatus = <a href="ota_mqtt.c.html#460">unsubscribeFromJobNotificationTopic</a>( pAgentCtx );</div><div id="1186" class="line none"> 1186 </div><div id="1187" class="line none"> 1187         if( mqttStatus != <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="1188" class="line none"> 1188         {</div><div id="1189" class="line none"> 1189             LogWarn( ( "Failed cleanup for MQTT control plane: "</div><div id="1190" class="line none"> 1190                        "unsubscribeFromJobNotificationTopic returned error: "</div><div id="1191" class="line none"> 1191                        "OtaMqttStatus_t=%s",</div><div id="1192" class="line none"> 1192                        <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ) ) );</div><div id="1193" class="line none"> 1193             result = <a href="include/ota.h.html#83">OtaErrCleanupControlFailed</a>;</div><div id="1194" class="line none"> 1194         }</div><div id="1195" class="line none"> 1195     }</div><div id="1196" class="line none"> 1196 </div><div id="1197" class="line none"> 1197     return result;</div><div id="1198" class="line none"> 1198 }</div><div id="1199" class="line none"> 1199 </div><div id="1200" class="line none"> 1200 /*</div><div id="1201" class="line none"> 1201  * Perform any cleanup operations required for data plane.</div><div id="1202" class="line none"> 1202  */</div><div id="1203" class="line none"> 1203 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_mqtt.c.html#1203">cleanupData_Mqtt</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="1204" class="line none"> 1204 {</div><div id="1205" class="line none"> 1205     <a href="include/ota.h.html#97">OtaErr_t</a> result = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="1206" class="line none"> 1206     <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> mqttStatus = <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>;</div><div id="1207" class="line none"> 1207 </div><div id="1208" class="line none"> 1208     assert( pAgentCtx != NULL );</div><div id="1209" class="line none"> 1209 </div><div id="1210" class="line none"> 1210     if( pAgentCtx-&gt;<a href="include/ota.h.html#303">unsubscribeOnShutdown</a> != 0U )</div><div id="1211" class="line none"> 1211     {</div><div id="1212" class="line none"> 1212         /* Unsubscribe from data stream topics. */</div><div id="1213" class="line none"> 1213         mqttStatus = <a href="ota_mqtt.c.html#399">unsubscribeFromDataStream</a>( pAgentCtx );</div><div id="1214" class="line none"> 1214 </div><div id="1215" class="line none"> 1215         if( mqttStatus != <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a> )</div><div id="1216" class="line none"> 1216         {</div><div id="1217" class="line none"> 1217             LogWarn( ( "Failed cleanup for MQTT data plane: "</div><div id="1218" class="line none"> 1218                        "unsubscribeFromDataStream returned error: "</div><div id="1219" class="line none"> 1219                        "OtaMqttStatus_t=%s",</div><div id="1220" class="line none"> 1220                        <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( mqttStatus ) ) );</div><div id="1221" class="line none"> 1221             result = <a href="include/ota.h.html#84">OtaErrCleanupDataFailed</a>;</div><div id="1222" class="line none"> 1222         }</div><div id="1223" class="line none"> 1223     }</div><div id="1224" class="line none"> 1224 </div><div id="1225" class="line none"> 1225     return result;</div><div id="1226" class="line none"> 1226 }</div><div id="1227" class="line none"> 1227 </div><div id="1228" class="line none"> 1228 const char * <a href="ota_mqtt.c.html#1228">OTA_MQTT_strerror</a>( <a href="include/ota_mqtt_interface.h.html#87">OtaMqttStatus_t</a> <a href="include/ota.h.html#202">status</a> )</div><div id="1229" class="line none"> 1229 {</div><div id="1230" class="line none"> 1230     const char * str = NULL;</div><div id="1231" class="line none"> 1231 </div><div id="1232" class="line none"> 1232     switch( <a href="include/ota.h.html#202">status</a> )</div><div id="1233" class="line none"> 1233     {</div><div id="1234" class="line none"> 1234         case <a href="include/ota_mqtt_interface.h.html#83">OtaMqttSuccess</a>:</div><div id="1235" class="line none"> 1235             str = "OtaMqttSuccess";</div><div id="1236" class="line none"> 1236             break;</div><div id="1237" class="line none"> 1237 </div><div id="1238" class="line none"> 1238         case <a href="include/ota_mqtt_interface.h.html#84">OtaMqttPublishFailed</a>:</div><div id="1239" class="line none"> 1239             str = "OtaMqttPublishFailed";</div><div id="1240" class="line none"> 1240             break;</div><div id="1241" class="line none"> 1241 </div><div id="1242" class="line none"> 1242         case <a href="include/ota_mqtt_interface.h.html#85">OtaMqttSubscribeFailed</a>:</div><div id="1243" class="line none"> 1243             str = "OtaMqttSubscribeFailed";</div><div id="1244" class="line none"> 1244             break;</div><div id="1245" class="line none"> 1245 </div><div id="1246" class="line none"> 1246         case <a href="include/ota_mqtt_interface.h.html#86">OtaMqttUnsubscribeFailed</a>:</div><div id="1247" class="line none"> 1247             str = "OtaMqttUnsubscribeFailed";</div><div id="1248" class="line none"> 1248             break;</div><div id="1249" class="line none"> 1249 </div><div id="1250" class="line none"> 1250         default:</div><div id="1251" class="line none"> 1251             str = "InvalidErrorCode";</div><div id="1252" class="line none"> 1252             break;</div><div id="1253" class="line none"> 1253     }</div><div id="1254" class="line none"> 1254 </div><div id="1255" class="line none"> 1255     return str;</div><div id="1256" class="line none"> 1256 }</div>
</div>
</body>
</html>
