
<html>
<head>
<title>source/ota_interface.c</title>
<link rel="stylesheet" type="text/css" href="../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * AWS IoT Over-the-air Update v3.0.0</div><div id="3" class="line none">    3  * Copyright (C) 2020 Amazon.com, Inc. or its affiliates.  All Rights Reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * Permission is hereby granted, free of charge, to any person obtaining a copy of</div><div id="6" class="line none">    6  * this software and associated documentation files (the "Software"), to deal in</div><div id="7" class="line none">    7  * the Software without restriction, including without limitation the rights to</div><div id="8" class="line none">    8  * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</div><div id="9" class="line none">    9  * the Software, and to permit persons to whom the Software is furnished to do so,</div><div id="10" class="line none">   10  * subject to the following conditions:</div><div id="11" class="line none">   11  *</div><div id="12" class="line none">   12  * The above copyright notice and this permission notice shall be included in all</div><div id="13" class="line none">   13  * copies or substantial portions of the Software.</div><div id="14" class="line none">   14  *</div><div id="15" class="line none">   15  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</div><div id="16" class="line none">   16  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS</div><div id="17" class="line none">   17  * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR</div><div id="18" class="line none">   18  * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER</div><div id="19" class="line none">   19  * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</div><div id="20" class="line none">   20  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</div><div id="21" class="line none">   21  */</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 /**</div><div id="24" class="line none">   24  * @file ota_interface.c</div><div id="25" class="line none">   25  * @brief Internal interface for setting the data and control planes.</div><div id="26" class="line none">   26  */</div><div id="27" class="line none">   27 </div><div id="28" class="line none">   28 /* Standard library includes. */</div><div id="29" class="line none">   29 #include &lt;string.h&gt;</div><div id="30" class="line none">   30 #include &lt;assert.h&gt;</div><div id="31" class="line none">   31 </div><div id="32" class="line none">   32 /* OTA interface includes. */</div><div id="33" class="line none">   33 #include "ota_interface_private.h"</div><div id="34" class="line none">   34 </div><div id="35" class="line none">   35 /* OTA transport interface includes. */</div><div id="36" class="line none">   36 </div><div id="37" class="line none">   37 #if ( configENABLED_DATA_PROTOCOLS &amp; <a href="include/ota_interface_private.h.html#41">OTA_DATA_OVER_MQTT</a> ) || ( configENABLED_CONTROL_PROTOCOL &amp; <a href="include/ota_interface_private.h.html#38">OTA_CONTROL_OVER_MQTT</a> )</div><div id="38" class="line none">   38     #include "ota_mqtt_private.h"</div><div id="39" class="line none">   39 #endif</div><div id="40" class="line none">   40 </div><div id="41" class="line none">   41 #if ( configENABLED_DATA_PROTOCOLS &amp; <a href="include/ota_interface_private.h.html#42">OTA_DATA_OVER_HTTP</a> )</div><div id="42" class="line none">   42     #include "ota_http_private.h"</div><div id="43" class="line none">   43 #endif</div><div id="44" class="line none">   44 </div><div id="45" class="line none">   45 /* Check for invalid data interface configurations. */</div><div id="46" class="line none">   46 </div><div id="47" class="line none">   47 #if !( configENABLED_DATA_PROTOCOLS &amp; configOTA_PRIMARY_DATA_PROTOCOL )</div><div id="48" class="line none">   48     #error "Primary data protocol must be enabled in the OTA configuration file."</div><div id="49" class="line none">   49 #endif</div><div id="50" class="line none">   50 </div><div id="51" class="line none">   51 #if !( ( configENABLED_DATA_PROTOCOLS &amp; <a href="include/ota_interface_private.h.html#41">OTA_DATA_OVER_MQTT</a> ) | ( configENABLED_DATA_PROTOCOLS &amp; <a href="include/ota_interface_private.h.html#42">OTA_DATA_OVER_HTTP</a> ) )</div><div id="52" class="line none">   52     #error "One or more of the data protocols must be set with configENABLED_DATA_PROTOCOLS."</div><div id="53" class="line none">   53 #endif</div><div id="54" class="line none">   54 </div><div id="55" class="line none">   55 #if !( ( configOTA_PRIMARY_DATA_PROTOCOL &amp; <a href="include/ota_interface_private.h.html#41">OTA_DATA_OVER_MQTT</a> ) | ( configOTA_PRIMARY_DATA_PROTOCOL &amp; <a href="include/ota_interface_private.h.html#42">OTA_DATA_OVER_HTTP</a> ) )</div><div id="56" class="line none">   56     #error "configOTA_PRIMARY_DATA_PROTOCOL must be set to OTA_DATA_OVER_MQTT or OTA_DATA_OVER_HTTP."</div><div id="57" class="line none">   57 #endif</div><div id="58" class="line none">   58 </div><div id="59" class="line none">   59 #if ( configOTA_PRIMARY_DATA_PROTOCOL &gt;= ( <a href="include/ota_interface_private.h.html#41">OTA_DATA_OVER_MQTT</a> | <a href="include/ota_interface_private.h.html#42">OTA_DATA_OVER_HTTP</a> ) )</div><div id="60" class="line none">   60     #error "Invalid value for configOTA_PRIMARY_DATA_PROTOCOL: Value is expected to be OTA_DATA_OVER_MQTT or OTA_DATA_OVER_HTTP."</div><div id="61" class="line none">   61 #endif</div><div id="62" class="line none">   62 </div><div id="63" class="line none">   63 void <a href="ota_interface.c.html#63">setControlInterface</a>( <a href="include/ota_interface_private.h.html#60">OtaControlInterface_t</a> * pControlInterface )</div><div id="64" class="line none">   64 {</div><div id="65" class="line none">   65     assert( pControlInterface != NULL );</div><div id="66" class="line none">   66 </div><div id="67" class="line none">   67     #if ( configENABLED_CONTROL_PROTOCOL == <a href="include/ota_interface_private.h.html#38">OTA_CONTROL_OVER_MQTT</a> )</div><div id="68" class="line none">   68         pControlInterface-&gt;<a href="include/ota_interface_private.h.html#54">requestJob</a> = <a href="include/ota_mqtt_private.h.html#46">requestJob_Mqtt</a>;</div><div id="69" class="line none">   69         pControlInterface-&gt;<a href="include/ota_interface_private.h.html#55">updateJobStatus</a> = <a href="include/ota_mqtt_private.h.html#143">updateJobStatus_Mqtt</a>;</div><div id="70" class="line none">   70         pControlInterface-&gt;<a href="include/ota_interface_private.h.html#59">cleanup</a> = <a href="include/ota_mqtt_private.h.html#111">cleanupControl_Mqtt</a>;</div><div id="71" class="line none">   71     #else</div><div id="72" class="line none">   72     #error "Enable MQTT control as control operations are only supported over MQTT."</div><div id="73" class="line none">   73     #endif</div><div id="74" class="line none">   74 }</div><div id="75" class="line none">   75 </div><div id="76" class="line none">   76 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_interface.c.html#76">setDataInterface</a>( <a href="include/ota_interface_private.h.html#80">OtaDataInterface_t</a> * pDataInterface,</div><div id="77" class="line none">   77                            const uint8_t * pProtocol )</div><div id="78" class="line none">   78 {</div><div id="79" class="line hit">   79     <a href="include/ota.h.html#97">OtaErr_t</a> err = <a href="include/ota.h.html#87">OtaErrInvalidDataProtocol</a>;</div><div id="80" class="line hit">   80     bool httpInJobDoc;</div><div id="81" class="line hit">   81     bool mqttInJobDoc;</div><div id="82" class="line none">   82 </div><div id="83" class="line hit">   83     httpInJobDoc = ( strstr( ( const char * ) pProtocol, "\"HTTP\"" ) != NULL ) ? true : false;</div><div id="84" class="line hit">   84     mqttInJobDoc = ( strstr( ( const char * ) pProtocol, "\"MQTT\"" ) != NULL ) ? true : false;</div><div id="85" class="line none">   85 </div><div id="86" class="line none">   86     #if ( ( configENABLED_DATA_PROTOCOLS &amp; <a href="include/ota_interface_private.h.html#41">OTA_DATA_OVER_MQTT</a> ) &amp;&amp; !( configENABLED_DATA_PROTOCOLS &amp; <a href="include/ota_interface_private.h.html#42">OTA_DATA_OVER_HTTP</a> ) )</div><div id="87" class="line hit">   87         ( void ) httpInJobDoc;</div><div id="88" class="line none">   88 </div><div id="89" class="line hit">   89         if( mqttInJobDoc == true )</div><div id="90" class="line none">   90         {</div><div id="91" class="line hit">   91             pDataInterface-&gt;<a href="include/ota_interface_private.h.html#70">initFileTransfer</a> = <a href="include/ota_mqtt_private.h.html#59">initFileTransfer_Mqtt</a>;</div><div id="92" class="line hit">   92             pDataInterface-&gt;<a href="include/ota_interface_private.h.html#71">requestFileBlock</a> = <a href="include/ota_mqtt_private.h.html#73">requestFileBlock_Mqtt</a>;</div><div id="93" class="line hit">   93             pDataInterface-&gt;<a href="include/ota_interface_private.h.html#72">decodeFileBlock</a> = <a href="include/ota_mqtt_private.h.html#92">decodeFileBlock_Mqtt</a>;</div><div id="94" class="line hit">   94             pDataInterface-&gt;<a href="include/ota_interface_private.h.html#59">cleanup</a> = <a href="include/ota_mqtt_private.h.html#124">cleanupData_Mqtt</a>;</div><div id="95" class="line hit">   95             err = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="96" class="line none">   96         }</div><div id="97" class="line none">   97     #elif ( ( configENABLED_DATA_PROTOCOLS &amp; <a href="include/ota_interface_private.h.html#42">OTA_DATA_OVER_HTTP</a> ) &amp;&amp; !( configENABLED_DATA_PROTOCOLS &amp; <a href="include/ota_interface_private.h.html#41">OTA_DATA_OVER_MQTT</a> ) )</div><div id="98" class="line none">   98         ( void ) mqttInJobDoc;</div><div id="99" class="line none">   99 </div><div id="100" class="line none">  100         if( httpInJobDoc == true )</div><div id="101" class="line none">  101         {</div><div id="102" class="line none">  102             pDataInterface-&gt;<a href="include/ota_interface_private.h.html#70">initFileTransfer</a> = initFileTransfer_Http;</div><div id="103" class="line none">  103             pDataInterface-&gt;<a href="include/ota_interface_private.h.html#71">requestFileBlock</a> = requestDataBlock_Http;</div><div id="104" class="line none">  104             pDataInterface-&gt;<a href="include/ota_interface_private.h.html#72">decodeFileBlock</a> = decodeFileBlock_Http;</div><div id="105" class="line none">  105             pDataInterface-&gt;<a href="include/ota_interface_private.h.html#59">cleanup</a> = cleanupData_Http;</div><div id="106" class="line none">  106             err = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="107" class="line none">  107         }</div><div id="108" class="line none">  108     #else /* if ( ( configENABLED_DATA_PROTOCOLS &amp; OTA_DATA_OVER_MQTT ) &amp;&amp; !( configENABLED_DATA_PROTOCOLS &amp; OTA_DATA_OVER_HTTP ) ) */</div><div id="109" class="line none">  109         #if ( configOTA_PRIMARY_DATA_PROTOCOL == <a href="include/ota_interface_private.h.html#41">OTA_DATA_OVER_MQTT</a> )</div><div id="110" class="line none">  110             if( mqttInJobDoc == true )</div><div id="111" class="line none">  111             {</div><div id="112" class="line none">  112                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#70">initFileTransfer</a> = <a href="include/ota_mqtt_private.h.html#59">initFileTransfer_Mqtt</a>;</div><div id="113" class="line none">  113                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#71">requestFileBlock</a> = <a href="include/ota_mqtt_private.h.html#73">requestFileBlock_Mqtt</a>;</div><div id="114" class="line none">  114                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#72">decodeFileBlock</a> = <a href="include/ota_mqtt_private.h.html#92">decodeFileBlock_Mqtt</a>;</div><div id="115" class="line none">  115                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#59">cleanup</a> = <a href="include/ota_mqtt_private.h.html#124">cleanupData_Mqtt</a>;</div><div id="116" class="line none">  116                 err = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="117" class="line none">  117             }</div><div id="118" class="line none">  118             else if( httpInJobDoc == true )</div><div id="119" class="line none">  119             {</div><div id="120" class="line none">  120                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#70">initFileTransfer</a> = initFileTransfer_Http;</div><div id="121" class="line none">  121                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#71">requestFileBlock</a> = requestDataBlock_Http;</div><div id="122" class="line none">  122                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#72">decodeFileBlock</a> = decodeFileBlock_Http;</div><div id="123" class="line none">  123                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#59">cleanup</a> = cleanupData_Http;</div><div id="124" class="line none">  124                 err = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="125" class="line none">  125             }</div><div id="126" class="line none">  126         #elif ( configOTA_PRIMARY_DATA_PROTOCOL == <a href="include/ota_interface_private.h.html#42">OTA_DATA_OVER_HTTP</a> )</div><div id="127" class="line none">  127             if( httpInJobDoc == true )</div><div id="128" class="line none">  128             {</div><div id="129" class="line none">  129                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#70">initFileTransfer</a> = initFileTransfer_Http;</div><div id="130" class="line none">  130                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#71">requestFileBlock</a> = requestDataBlock_Http;</div><div id="131" class="line none">  131                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#72">decodeFileBlock</a> = decodeFileBlock_Http;</div><div id="132" class="line none">  132                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#59">cleanup</a> = cleanupData_Http;</div><div id="133" class="line none">  133                 err = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="134" class="line none">  134             }</div><div id="135" class="line none">  135             else if( mqttInJobDoc == true )</div><div id="136" class="line none">  136             {</div><div id="137" class="line none">  137                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#70">initFileTransfer</a> = <a href="include/ota_mqtt_private.h.html#59">initFileTransfer_Mqtt</a>;</div><div id="138" class="line none">  138                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#71">requestFileBlock</a> = <a href="include/ota_mqtt_private.h.html#73">requestFileBlock_Mqtt</a>;</div><div id="139" class="line none">  139                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#72">decodeFileBlock</a> = <a href="include/ota_mqtt_private.h.html#92">decodeFileBlock_Mqtt</a>;</div><div id="140" class="line none">  140                 pDataInterface-&gt;<a href="include/ota_interface_private.h.html#59">cleanup</a> = <a href="include/ota_mqtt_private.h.html#124">cleanupData_Mqtt</a>;</div><div id="141" class="line none">  141                 err = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="142" class="line none">  142             }</div><div id="143" class="line none">  143         #endif /* if ( configOTA_PRIMARY_DATA_PROTOCOL == OTA_DATA_OVER_MQTT ) */</div><div id="144" class="line none">  144     #endif /* if ( ( configENABLED_DATA_PROTOCOLS &amp; OTA_DATA_OVER_MQTT ) &amp;&amp; !( configENABLED_DATA_PROTOCOLS &amp; OTA_DATA_OVER_HTTP ) ) */</div><div id="145" class="line none">  145 </div><div id="146" class="line hit">  146     return err;</div><div id="147" class="line hit">  147 }</div>
</div>
</body>
</html>
