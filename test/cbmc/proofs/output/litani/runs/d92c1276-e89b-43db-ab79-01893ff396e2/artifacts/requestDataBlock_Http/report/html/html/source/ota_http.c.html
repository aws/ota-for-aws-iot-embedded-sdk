
<html>
<head>
<title>source/ota_http.c</title>
<link rel="stylesheet" type="text/css" href="../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * AWS IoT Over-the-air Update v3.0.0</div><div id="3" class="line none">    3  * Copyright (C) 2020 Amazon.com, Inc. or its affiliates.  All Rights Reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * Permission is hereby granted, free of charge, to any person obtaining a copy of</div><div id="6" class="line none">    6  * this software and associated documentation files (the "Software"), to deal in</div><div id="7" class="line none">    7  * the Software without restriction, including without limitation the rights to</div><div id="8" class="line none">    8  * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</div><div id="9" class="line none">    9  * the Software, and to permit persons to whom the Software is furnished to do so,</div><div id="10" class="line none">   10  * subject to the following conditions:</div><div id="11" class="line none">   11  *</div><div id="12" class="line none">   12  * The above copyright notice and this permission notice shall be included in all</div><div id="13" class="line none">   13  * copies or substantial portions of the Software.</div><div id="14" class="line none">   14  *</div><div id="15" class="line none">   15  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</div><div id="16" class="line none">   16  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS</div><div id="17" class="line none">   17  * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR</div><div id="18" class="line none">   18  * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER</div><div id="19" class="line none">   19  * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</div><div id="20" class="line none">   20  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</div><div id="21" class="line none">   21  */</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 /**</div><div id="24" class="line none">   24  * @file ota_http.c</div><div id="25" class="line none">   25  * @brief Data transfer over HTTP routines.</div><div id="26" class="line none">   26  */</div><div id="27" class="line none">   27 </div><div id="28" class="line none">   28 /* Standard library include. */</div><div id="29" class="line none">   29 #include &lt;string.h&gt;</div><div id="30" class="line none">   30 #include &lt;stdio.h&gt;</div><div id="31" class="line none">   31 #include &lt;assert.h&gt;</div><div id="32" class="line none">   32 </div><div id="33" class="line none">   33 /* OTA includes. */</div><div id="34" class="line none">   34 #include "ota.h"</div><div id="35" class="line none">   35 #include "ota_private.h"</div><div id="36" class="line none">   36 #include "ota_http_private.h"</div><div id="37" class="line none">   37 </div><div id="38" class="line none">   38 /**</div><div id="39" class="line none">   39  * @brief Track the current block for HTTP requests</div><div id="40" class="line none">   40  *</div><div id="41" class="line none">   41  */</div><div id="42" class="line none">   42 static uint32_t <a href="ota_http.c.html#42">currBlock</a>;</div><div id="43" class="line none">   43 </div><div id="44" class="line none">   44 /*</div><div id="45" class="line none">   45  * Init file transfer by initializing the http module with the pre-signed url.</div><div id="46" class="line none">   46  */</div><div id="47" class="line none">   47 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_http.c.html#47">initFileTransfer_Http</a>( <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="48" class="line none">   48 {</div><div id="49" class="line none">   49     <a href="include/ota_http_interface.h.html#85">OtaHttpStatus_t</a> httpStatus = <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a>;</div><div id="50" class="line none">   50     char * pURL = NULL;</div><div id="51" class="line none">   51     <a href="include/ota_private.h.html#408">OtaFileContext_t</a> * <a href="include/ota.h.html#291">fileContext</a> = NULL;</div><div id="52" class="line none">   52 </div><div id="53" class="line none">   53     LogDebug( ( "Invoking initFileTransfer_Http" ) );</div><div id="54" class="line none">   54     assert( pAgentCtx != NULL &amp;&amp; pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a> != NULL );</div><div id="55" class="line none">   55 </div><div id="56" class="line none">   56     /* File context from OTA agent. */</div><div id="57" class="line none">   57     <a href="include/ota.h.html#291">fileContext</a> = &amp;( pAgentCtx-&gt;<a href="include/ota.h.html#291">fileContext</a> );</div><div id="58" class="line none">   58 </div><div id="59" class="line none">   59     /* Get pre-signed URL from pAgentCtx. */</div><div id="60" class="line none">   60     pURL = ( char * ) <a href="include/ota.h.html#291">fileContext</a>-&gt;<a href="include/ota_private.h.html#396">pUpdateUrlPath</a>;</div><div id="61" class="line none">   61 </div><div id="62" class="line none">   62     /* Connect to the HTTP server and initialize download information. */</div><div id="63" class="line none">   63     httpStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#254">http</a>.<a href="include/ota_http_interface.h.html#131">init</a>( pURL );</div><div id="64" class="line none">   64 </div><div id="65" class="line none">   65     if( httpStatus != <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a> )</div><div id="66" class="line none">   66     {</div><div id="67" class="line none">   67         LogError( ( "Error occured while initializing http:"</div><div id="68" class="line none">   68                     "OtaHttpStatus_t=%s"</div><div id="69" class="line none">   69                     , <a href="ota_http.c.html#175">OTA_HTTP_strerror</a>( httpStatus ) ) );</div><div id="70" class="line none">   70     }</div><div id="71" class="line none">   71 </div><div id="72" class="line none">   72     return ( httpStatus == <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a> ) ? <a href="include/ota.h.html#74">OtaErrNone</a> : <a href="include/ota.h.html#81">OtaErrInitFileTransferFailed</a>;</div><div id="73" class="line none">   73 }</div><div id="74" class="line none">   74 </div><div id="75" class="line none">   75 /*</div><div id="76" class="line none">   76  * Check for next available OTA job from the job service.</div><div id="77" class="line none">   77  */</div><div id="78" class="line none">   78 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_http.c.html#78">requestDataBlock_Http</a>( <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="79" class="line none">   79 {</div><div id="80" class="line hit">   80     <a href="include/ota_http_interface.h.html#85">OtaHttpStatus_t</a> httpStatus = <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a>;</div><div id="81" class="line none">   81 </div><div id="82" class="line none">   82     /* Values for the "Range" field in HTTP header. */</div><div id="83" class="line hit">   83     uint32_t rangeStart = 0;</div><div id="84" class="line hit">   84     uint32_t rangeEnd = 0;</div><div id="85" class="line none">   85 </div><div id="86" class="line hit">   86     <a href="include/ota_private.h.html#408">OtaFileContext_t</a> * <a href="include/ota.h.html#291">fileContext</a> = NULL;</div><div id="87" class="line none">   87 </div><div id="88" class="line both">   88     assert( pAgentCtx != NULL &amp;&amp; pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a> != NULL );</div><div id="89" class="line none">   89     LogDebug( ( "Invoking requestDataBlock_Http" ) );</div><div id="90" class="line none">   90 </div><div id="91" class="line hit">   91     <a href="include/ota.h.html#291">fileContext</a> = &amp;( pAgentCtx-&gt;<a href="include/ota.h.html#291">fileContext</a> );</div><div id="92" class="line none">   92 </div><div id="93" class="line none">   93     /* Calculate ranges. */</div><div id="94" class="line hit">   94     rangeStart = <a href="ota_http.c.html#42">currBlock</a> * <a href="include/ota_private.h.html#56">OTA_FILE_BLOCK_SIZE</a>;</div><div id="95" class="line none">   95 </div><div id="96" class="line hit">   96     if( <a href="include/ota.h.html#291">fileContext</a>-&gt;<a href="include/ota_private.h.html#385">blocksRemaining</a> == 1U )</div><div id="97" class="line none">   97     {</div><div id="98" class="line hit">   98         rangeEnd = <a href="include/ota.h.html#291">fileContext</a>-&gt;<a href="include/ota_private.h.html#384">fileSize</a> - 1U;</div><div id="99" class="line none">   99     }</div><div id="100" class="line none">  100     else</div><div id="101" class="line none">  101     {</div><div id="102" class="line hit">  102         rangeEnd = rangeStart + <a href="include/ota_private.h.html#56">OTA_FILE_BLOCK_SIZE</a> - 1U;</div><div id="103" class="line none">  103     }</div><div id="104" class="line none">  104 </div><div id="105" class="line none">  105     /* Request file data over HTTP using the rangeStart and rangeEnd. */</div><div id="106" class="line both">  106     httpStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#254">http</a>.<a href="../test/cbmc/proofs/ota_http/requestDataBlock_Http/requestDataBlock_Http_harness.c.html#30">request</a>( rangeStart, rangeEnd );</div><div id="107" class="line none">  107 </div><div id="108" class="line hit">  108     if( httpStatus != <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a> )</div><div id="109" class="line none">  109     {</div><div id="110" class="line none">  110         LogError( ( "Error occured while requesting data block:"</div><div id="111" class="line none">  111                     "OtaHttpStatus_t=%s"</div><div id="112" class="line none">  112                     , <a href="ota_http.c.html#175">OTA_HTTP_strerror</a>( httpStatus ) ) );</div><div id="113" class="line none">  113     }</div><div id="114" class="line none">  114 </div><div id="115" class="line hit">  115     return ( httpStatus == <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a> ) ? <a href="include/ota.h.html#74">OtaErrNone</a> : <a href="include/ota.h.html#82">OtaErrRequestFileBlockFailed</a>;</div><div id="116" class="line hit">  116 }</div><div id="117" class="line none">  117 </div><div id="118" class="line none">  118 /*</div><div id="119" class="line none">  119  * HTTP file block does not need to decode the block, only increment</div><div id="120" class="line none">  120  * number of blocks received.</div><div id="121" class="line none">  121  */</div><div id="122" class="line none">  122 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_http.c.html#122">decodeFileBlock_Http</a>( const uint8_t * pMessageBuffer,</div><div id="123" class="line none">  123                                size_t messageSize,</div><div id="124" class="line none">  124                                int32_t * pFileId,</div><div id="125" class="line none">  125                                int32_t * pBlockId,</div><div id="126" class="line none">  126                                int32_t * pBlockSize,</div><div id="127" class="line none">  127                                uint8_t ** pPayload,</div><div id="128" class="line none">  128                                size_t * pPayloadSize )</div><div id="129" class="line none">  129 {</div><div id="130" class="line none">  130     <a href="include/ota.h.html#97">OtaErr_t</a> err = <a href="include/ota.h.html#74">OtaErrNone</a>;</div><div id="131" class="line none">  131 </div><div id="132" class="line none">  132     assert( pMessageBuffer != NULL &amp;&amp; pFileId != NULL &amp;&amp; pBlockId != NULL &amp;&amp;</div><div id="133" class="line none">  133             pBlockSize != NULL &amp;&amp; pPayload != NULL &amp;&amp; pPayloadSize != NULL );</div><div id="134" class="line none">  134 </div><div id="135" class="line none">  135     if( messageSize &gt; <a href="include/ota_private.h.html#56">OTA_FILE_BLOCK_SIZE</a> )</div><div id="136" class="line none">  136     {</div><div id="137" class="line none">  137         LogError( ( "Incoming file block size %d larger than block size %d.",</div><div id="138" class="line none">  138                     ( int ) messageSize, ( int ) <a href="include/ota_private.h.html#56">OTA_FILE_BLOCK_SIZE</a> ) );</div><div id="139" class="line none">  139         err = <a href="include/ota.h.html#77">OtaErrInvalidArg</a>;</div><div id="140" class="line none">  140     }</div><div id="141" class="line none">  141     else</div><div id="142" class="line none">  142     {</div><div id="143" class="line none">  143         *pFileId = 0;</div><div id="144" class="line none">  144         *pBlockId = ( int32_t ) <a href="ota_http.c.html#42">currBlock</a>;</div><div id="145" class="line none">  145         *pBlockSize = ( int32_t ) messageSize;</div><div id="146" class="line none">  146 </div><div id="147" class="line none">  147         /* The data received over HTTP does not require any decoding. */</div><div id="148" class="line none">  148         ( void ) memcpy( *pPayload, pMessageBuffer, messageSize );</div><div id="149" class="line none">  149 </div><div id="150" class="line none">  150         *pPayloadSize = messageSize;</div><div id="151" class="line none">  151 </div><div id="152" class="line none">  152         /* Current block is processed, set the file block to next. */</div><div id="153" class="line none">  153         <a href="ota_http.c.html#42">currBlock</a>++;</div><div id="154" class="line none">  154     }</div><div id="155" class="line none">  155 </div><div id="156" class="line none">  156     return err;</div><div id="157" class="line none">  157 }</div><div id="158" class="line none">  158 </div><div id="159" class="line none">  159 /*</div><div id="160" class="line none">  160  * Perform any cleanup operations required for data plane.</div><div id="161" class="line none">  161  */</div><div id="162" class="line none">  162 <a href="include/ota.h.html#97">OtaErr_t</a> <a href="ota_http.c.html#162">cleanupData_Http</a>( const <a href="include/ota.h.html#304">OtaAgentContext_t</a> * pAgentCtx )</div><div id="163" class="line none">  163 {</div><div id="164" class="line none">  164     <a href="include/ota_http_interface.h.html#85">OtaHttpStatus_t</a> httpStatus = <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a>;</div><div id="165" class="line none">  165 </div><div id="166" class="line none">  166     assert( pAgentCtx != NULL &amp;&amp; pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a> != NULL );</div><div id="167" class="line none">  167     httpStatus = pAgentCtx-&gt;<a href="include/ota.h.html#301">pOtaInterface</a>-&gt;<a href="include/ota.h.html#254">http</a>.<a href="include/ota_http_interface.h.html#133">deinit</a>();</div><div id="168" class="line none">  168 </div><div id="169" class="line none">  169     /* Reset currBlock. */</div><div id="170" class="line none">  170     <a href="ota_http.c.html#42">currBlock</a> = 0;</div><div id="171" class="line none">  171 </div><div id="172" class="line none">  172     return ( httpStatus == <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a> ) ? <a href="include/ota.h.html#74">OtaErrNone</a> : <a href="include/ota.h.html#84">OtaErrCleanupDataFailed</a>;</div><div id="173" class="line none">  173 }</div><div id="174" class="line none">  174 </div><div id="175" class="line none">  175 const char * <a href="ota_http.c.html#175">OTA_HTTP_strerror</a>( <a href="include/ota_http_interface.h.html#85">OtaHttpStatus_t</a> <a href="include/ota.h.html#202">status</a> )</div><div id="176" class="line none">  176 {</div><div id="177" class="line none">  177     const char * str = NULL;</div><div id="178" class="line none">  178 </div><div id="179" class="line none">  179     switch( <a href="include/ota.h.html#202">status</a> )</div><div id="180" class="line none">  180     {</div><div id="181" class="line none">  181         case <a href="include/ota_http_interface.h.html#81">OtaHttpSuccess</a>:</div><div id="182" class="line none">  182             str = "OtaHttpSuccess";</div><div id="183" class="line none">  183             break;</div><div id="184" class="line none">  184 </div><div id="185" class="line none">  185         case <a href="include/ota_http_interface.h.html#82">OtaHttpInitFailed</a>:</div><div id="186" class="line none">  186             str = "OtaHttpInitFailed";</div><div id="187" class="line none">  187             break;</div><div id="188" class="line none">  188 </div><div id="189" class="line none">  189         case <a href="include/ota_http_interface.h.html#83">OtaHttpDeinitFailed</a>:</div><div id="190" class="line none">  190             str = "OtaHttpDeinitFailed";</div><div id="191" class="line none">  191             break;</div><div id="192" class="line none">  192 </div><div id="193" class="line none">  193         case <a href="include/ota_http_interface.h.html#84">OtaHttpRequestFailed</a>:</div><div id="194" class="line none">  194             str = "OtaHttpRequestFailed";</div><div id="195" class="line none">  195             break;</div><div id="196" class="line none">  196 </div><div id="197" class="line none">  197         default:</div><div id="198" class="line none">  198             str = "InvalidErrorCode";</div><div id="199" class="line none">  199             break;</div><div id="200" class="line none">  200     }</div><div id="201" class="line none">  201 </div><div id="202" class="line none">  202     return str;</div><div id="203" class="line none">  203 }</div>
</div>
</body>
</html>
