
<html>
<head>
<title>source/include/ota.h</title>
<link rel="stylesheet" type="text/css" href="../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * AWS IoT Over-the-air Update v3.0.0</div><div id="3" class="line none">    3  * Copyright (C) 2020 Amazon.com, Inc. or its affiliates.  All Rights Reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * Permission is hereby granted, free of charge, to any person obtaining a copy of</div><div id="6" class="line none">    6  * this software and associated documentation files (the "Software"), to deal in</div><div id="7" class="line none">    7  * the Software without restriction, including without limitation the rights to</div><div id="8" class="line none">    8  * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</div><div id="9" class="line none">    9  * the Software, and to permit persons to whom the Software is furnished to do so,</div><div id="10" class="line none">   10  * subject to the following conditions:</div><div id="11" class="line none">   11  *</div><div id="12" class="line none">   12  * The above copyright notice and this permission notice shall be included in all</div><div id="13" class="line none">   13  * copies or substantial portions of the Software.</div><div id="14" class="line none">   14  *</div><div id="15" class="line none">   15  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</div><div id="16" class="line none">   16  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS</div><div id="17" class="line none">   17  * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR</div><div id="18" class="line none">   18  * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER</div><div id="19" class="line none">   19  * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</div><div id="20" class="line none">   20  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</div><div id="21" class="line none">   21  */</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 /**</div><div id="24" class="line none">   24  * @file ota.h</div><div id="25" class="line none">   25  * @brief OTA Agent Interface</div><div id="26" class="line none">   26  */</div><div id="27" class="line none">   27 </div><div id="28" class="line none">   28 #ifndef <a href="ota.h.html#29">OTA_H</a></div><div id="29" class="line none">   29 #define <a href="ota.h.html#29">OTA_H</a></div><div id="30" class="line none">   30 </div><div id="31" class="line none">   31 /* Standard includes. */</div><div id="32" class="line none">   32 /* For FILE type in OtaFileContext_t.*/</div><div id="33" class="line none">   33 #include &lt;stdio.h&gt;</div><div id="34" class="line none">   34 #include &lt;stdint.h&gt;</div><div id="35" class="line none">   35 </div><div id="36" class="line none">   36 /* OTA Library Interface include. */</div><div id="37" class="line none">   37 #include "ota_private.h"</div><div id="38" class="line none">   38 #include "ota_os_interface.h"</div><div id="39" class="line none">   39 #include "ota_mqtt_interface.h"</div><div id="40" class="line none">   40 #include "ota_http_interface.h"</div><div id="41" class="line none">   41 #include "ota_platform_interface.h"</div><div id="42" class="line none">   42 </div><div id="43" class="line none">   43 /**</div><div id="44" class="line none">   44  * @ingroup ota_helpers</div><div id="45" class="line none">   45  * @brief Evaluates to the length of a constant string defined like 'static const char str[]= "xyz";</div><div id="46" class="line none">   46  */</div><div id="47" class="line none">   47 #define <a href="ota.h.html#47">CONST_STRLEN</a>( s )    ( ( ( uint32_t ) sizeof( s ) ) - 1UL )</div><div id="48" class="line none">   48 </div><div id="49" class="line none">   49 </div><div id="50" class="line none">   50 #define <a href="ota.h.html#50">OTA_FILE_SIG_KEY_STR_MAX_LENGTH</a>    32 /*!&lt; Maximum length of the file signature key. */</div><div id="51" class="line none">   51 </div><div id="52" class="line none">   52 </div><div id="53" class="line none">   53 /**</div><div id="54" class="line none">   54  * @ingroup ota_helpers</div><div id="55" class="line none">   55  * @brief The OTA signature algorithm string is specified by the PAL.</div><div id="56" class="line none">   56  *</div><div id="57" class="line none">   57  */</div><div id="58" class="line none">   58 </div><div id="59" class="line none">   59 /* MISRA rule 8.6 requires identifier with external linkage to have exact one external definition.</div><div id="60" class="line none">   60  * However, this variable is defined in OTA platform abstraction layer implementation, which is</div><div id="61" class="line none">   61  * not in this repository but in C-SDK and amazon-freertos repo, so it's a false positive. */</div><div id="62" class="line none">   62 /* coverity[misra_c_2012_rule_8_6_violation] */</div><div id="63" class="line none">   63 extern const char OTA_JsonFileSignatureKey[ <a href="ota.h.html#50">OTA_FILE_SIG_KEY_STR_MAX_LENGTH</a> ];</div><div id="64" class="line none">   64 </div><div id="65" class="line none">   65 /*-------------------------- OTA enumerated types --------------------------*/</div><div id="66" class="line none">   66 </div><div id="67" class="line none">   67 /**</div><div id="68" class="line none">   68  * @ingroup ota_enum_types</div><div id="69" class="line none">   69  * @brief The OTA API return status.</div><div id="70" class="line none">   70  * OTA agent error codes are in the upper 8 bits of the 32 bit OTA error word, OtaErr_t.</div><div id="71" class="line none">   71  */</div><div id="72" class="line none">   72 typedef enum <a href="ota.h.html#72">OtaErr</a></div><div id="73" class="line none">   73 {</div><div id="74" class="line none">   74     <a href="ota.h.html#74">OtaErrNone</a> = 0,               /*!&lt; @brief No error occurred during the operation. */</div><div id="75" class="line none">   75     <a href="ota.h.html#75">OtaErrUninitialized</a>,          /*!&lt; @brief The error code has not yet been set by a logic path. */</div><div id="76" class="line none">   76     <a href="ota.h.html#76">OtaErrPanic</a>,                  /*!&lt; @brief Unrecoverable Firmware error. Probably should log error and reboot. */</div><div id="77" class="line none">   77     <a href="ota.h.html#77">OtaErrInvalidArg</a>,             /*!&lt; @brief API called with invalid argument. */</div><div id="78" class="line none">   78     <a href="ota.h.html#78">OtaErrAgentStopped</a>,           /*!&lt; @brief Returned when operations are performed that requires OTA Agent running &amp; its stopped. */</div><div id="79" class="line none">   79     <a href="ota.h.html#79">OtaErrSignalEventFailed</a>,      /*!&lt; @brief Failed to send event to OTA state machine. */</div><div id="80" class="line none">   80     <a href="ota.h.html#80">OtaErrRequestJobFailed</a>,       /*!&lt; @brief Failed to request the job document. */</div><div id="81" class="line none">   81     <a href="ota.h.html#81">OtaErrInitFileTransferFailed</a>, /*!&lt; @brief Failed to update the OTA job status. */</div><div id="82" class="line none">   82     <a href="ota.h.html#82">OtaErrRequestFileBlockFailed</a>, /*!&lt; @brief Failed to request file block. */</div><div id="83" class="line none">   83     <a href="ota.h.html#83">OtaErrCleanupControlFailed</a>,   /*!&lt; @brief Failed to clean up the control plane. */</div><div id="84" class="line none">   84     <a href="ota.h.html#84">OtaErrCleanupDataFailed</a>,      /*!&lt; @brief Failed to clean up the data plane. */</div><div id="85" class="line none">   85     <a href="ota.h.html#85">OtaErrUpdateJobStatusFailed</a>,  /*!&lt; @brief Failed to update the OTA job status. */</div><div id="86" class="line none">   86     <a href="ota.h.html#86">OtaErrJobParserError</a>,         /*!&lt; @brief An error occurred during job document parsing. See reason sub-code. */</div><div id="87" class="line none">   87     <a href="ota.h.html#87">OtaErrInvalidDataProtocol</a>,    /*!&lt; @brief Job does not have a valid protocol for data transfer. */</div><div id="88" class="line none">   88     <a href="ota.h.html#88">OtaErrMomentumAbort</a>,          /*!&lt; @brief Too many OTA stream requests without any response. */</div><div id="89" class="line none">   89     <a href="ota.h.html#89">OtaErrDowngradeNotAllowed</a>,    /*!&lt; @brief Firmware version is older than the previous version. */</div><div id="90" class="line none">   90     <a href="ota.h.html#90">OtaErrSameFirmwareVersion</a>,    /*!&lt; @brief Firmware version is the same as previous. New firmware could have failed to commit. */</div><div id="91" class="line none">   91     <a href="ota.h.html#91">OtaErrImageStateMismatch</a>,     /*!&lt; @brief The OTA job was in Self Test but the platform image state was not. Possible tampering. */</div><div id="92" class="line none">   92     <a href="ota.h.html#92">OtaErrNoActiveJob</a>,            /*!&lt; @brief Attempt to set final image state without an active job. */</div><div id="93" class="line none">   93     <a href="ota.h.html#93">OtaErrUserAbort</a>,              /*!&lt; @brief User aborted the active OTA. */</div><div id="94" class="line none">   94     <a href="ota.h.html#94">OtaErrFailedToEncodeCbor</a>,     /*!&lt; @brief Failed to encode CBOR object for requesting data block from streaming service. */</div><div id="95" class="line none">   95     <a href="ota.h.html#95">OtaErrFailedToDecodeCbor</a>,     /*!&lt; @brief Failed to decode CBOR object from streaming service response. */</div><div id="96" class="line none">   96     <a href="ota.h.html#96">OtaErrActivateFailed</a>          /*!&lt; @brief Failed to activate the new image. */</div><div id="97" class="line none">   97 } <a href="ota.h.html#97">OtaErr_t</a>;</div><div id="98" class="line none">   98 </div><div id="99" class="line none">   99 /**</div><div id="100" class="line none">  100  * @ingroup ota_enum_types</div><div id="101" class="line none">  101  * @brief OTA Agent states.</div><div id="102" class="line none">  102  *</div><div id="103" class="line none">  103  * The current state of the OTA Task (OTA Agent).</div><div id="104" class="line none">  104  *</div><div id="105" class="line none">  105  * @note There is currently support only for a single OTA context.</div><div id="106" class="line none">  106  */</div><div id="107" class="line none">  107 typedef enum <a href="ota.h.html#107">OtaState</a></div><div id="108" class="line none">  108 {</div><div id="109" class="line none">  109     <a href="ota.h.html#109">OtaAgentStateNoTransition</a> = -1,</div><div id="110" class="line none">  110     <a href="ota.h.html#110">OtaAgentStateInit</a> = 0,</div><div id="111" class="line none">  111     <a href="ota.h.html#111">OtaAgentStateReady</a>,</div><div id="112" class="line none">  112     <a href="ota.h.html#112">OtaAgentStateRequestingJob</a>,</div><div id="113" class="line none">  113     <a href="ota.h.html#113">OtaAgentStateWaitingForJob</a>,</div><div id="114" class="line none">  114     <a href="ota.h.html#114">OtaAgentStateCreatingFile</a>,</div><div id="115" class="line none">  115     <a href="ota.h.html#115">OtaAgentStateRequestingFileBlock</a>,</div><div id="116" class="line none">  116     <a href="ota.h.html#116">OtaAgentStateWaitingForFileBlock</a>,</div><div id="117" class="line none">  117     <a href="ota.h.html#117">OtaAgentStateClosingFile</a>,</div><div id="118" class="line none">  118     <a href="ota.h.html#118">OtaAgentStateSuspended</a>,</div><div id="119" class="line none">  119     <a href="ota.h.html#119">OtaAgentStateShuttingDown</a>,</div><div id="120" class="line none">  120     <a href="ota.h.html#120">OtaAgentStateStopped</a>,</div><div id="121" class="line none">  121     <a href="ota.h.html#121">OtaAgentStateAll</a></div><div id="122" class="line none">  122 } <a href="ota.h.html#122">OtaState_t</a>;</div><div id="123" class="line none">  123 </div><div id="124" class="line none">  124 /**</div><div id="125" class="line none">  125  * @ingroup ota_enum_types</div><div id="126" class="line none">  126  * @brief OTA job document parser error codes.</div><div id="127" class="line none">  127  */</div><div id="128" class="line none">  128 typedef enum <a href="ota.h.html#128">OtaJobParseErr</a></div><div id="129" class="line none">  129 {</div><div id="130" class="line none">  130     <a href="ota.h.html#130">OtaJobParseErrUnknown</a> = -1,        /* @brief The error code has not yet been set by a logic path. */</div><div id="131" class="line none">  131     <a href="ota.h.html#131">OtaJobParseErrNone</a> = 0,            /* @brief Signifies no error has occurred. */</div><div id="132" class="line none">  132     <a href="ota.h.html#132">OtaJobParseErrNullJob</a>,             /* @brief A null job was reported (no job ID). */</div><div id="133" class="line none">  133     <a href="ota.h.html#133">OtaJobParseErrUpdateCurrentJob</a>,    /* @brief We're already busy with the reported job ID. */</div><div id="134" class="line none">  134     <a href="ota.h.html#134">OtaJobParseErrZeroFileSize</a>,        /* @brief Job document specified a zero sized file. This is not allowed. */</div><div id="135" class="line none">  135     <a href="ota.h.html#135">OtaJobParseErrNonConformingJobDoc</a>, /* @brief The job document failed to fulfill the model requirements. */</div><div id="136" class="line none">  136     <a href="ota.h.html#136">OtaJobParseErrBadModelInitParams</a>,  /* @brief There was an invalid initialization parameter used in the document model. */</div><div id="137" class="line none">  137     <a href="ota.h.html#137">OtaJobParseErrNoContextAvailable</a>,  /* @brief There was not an OTA context available. */</div><div id="138" class="line none">  138     <a href="ota.h.html#138">OtaJobParseErrNoActiveJobs</a>         /* @brief No active jobs are available in the service. */</div><div id="139" class="line none">  139 } <a href="ota.h.html#139">OtaJobParseErr_t</a>;</div><div id="140" class="line none">  140 </div><div id="141" class="line none">  141 /**</div><div id="142" class="line none">  142  * @ingroup ota_enum_types</div><div id="143" class="line none">  143  * @brief OTA Job callback events.</div><div id="144" class="line none">  144  *</div><div id="145" class="line none">  145  * After an OTA update image is received and authenticated, the agent calls the user</div><div id="146" class="line none">  146  * callback (set with the @ref OTA_Init API) with the value OtaJobEventActivate to</div><div id="147" class="line none">  147  * signal that the device must be rebooted to activate the new image. When the device</div><div id="148" class="line none">  148  * boots, if the OTA job status is in self test mode, the agent calls the user callback</div><div id="149" class="line none">  149  * with the value OtaJobEventStartTest, signaling that any additional self tests</div><div id="150" class="line none">  150  * should be performed.</div><div id="151" class="line none">  151  *</div><div id="152" class="line none">  152  * If the OTA receive fails for any reason, the agent calls the user callback with</div><div id="153" class="line none">  153  * the value OtaJobEventFail instead to allow the user to log the failure and take</div><div id="154" class="line none">  154  * any action deemed appropriate by the user code.</div><div id="155" class="line none">  155  *</div><div id="156" class="line none">  156  * See the OtaImageState_t type for more information.</div><div id="157" class="line none">  157  */</div><div id="158" class="line none">  158 typedef enum <a href="ota.h.html#158">OtaJobEvent</a></div><div id="159" class="line none">  159 {</div><div id="160" class="line none">  160     <a href="ota.h.html#160">OtaJobEventActivate</a> = 0,       /*!&lt; @brief OTA receive is authenticated and ready to activate. */</div><div id="161" class="line none">  161     <a href="ota.h.html#161">OtaJobEventFail</a> = 1,           /*!&lt; @brief OTA receive failed. Unable to use this update. */</div><div id="162" class="line none">  162     <a href="ota.h.html#162">OtaJobEventStartTest</a> = 2,      /*!&lt; @brief OTA job is now in self test, perform user tests. */</div><div id="163" class="line none">  163     <a href="ota.h.html#163">OtaJobEventProcessed</a> = 3,      /*!&lt; @brief OTA event queued by OTA_SignalEvent is processed. */</div><div id="164" class="line none">  164     <a href="ota.h.html#164">OtaJobEventSelfTestFailed</a> = 4, /*!&lt; @brief OTA self-test failed for current job. */</div><div id="165" class="line none">  165     <a href="ota.h.html#165">OtaJobEventParseCustomJob</a> = 5, /*!&lt; @brief OTA event for parsing custom job document. */</div><div id="166" class="line none">  166     <a href="ota.h.html#166">OtaJobEventReceivedJob</a> = 6,    /*!&lt; @brief OTA event when a new valid AFT-OTA job is received. */</div><div id="167" class="line none">  167     <a href="ota.h.html#167">OtaJobEventUpdateComplete</a> = 7, /*!&lt; @brief OTA event when the update is completed. */</div><div id="168" class="line none">  168     <a href="ota.h.html#168">OtaLastJobEvent</a> = <a href="ota.h.html#162">OtaJobEventStartTest</a></div><div id="169" class="line none">  169 } <a href="ota.h.html#169">OtaJobEvent_t</a>;</div><div id="170" class="line none">  170 </div><div id="171" class="line none">  171 /**</div><div id="172" class="line none">  172  * @ingroup ota_enum_types</div><div id="173" class="line none">  173  * @brief Gives the status of the job operation.</div><div id="174" class="line none">  174  *</div><div id="175" class="line none">  175  */</div><div id="176" class="line none">  176 typedef enum</div><div id="177" class="line none">  177 {</div><div id="178" class="line none">  178     <a href="ota.h.html#178">JobStatusInProgress</a> = 0,</div><div id="179" class="line none">  179     <a href="ota.h.html#179">JobStatusFailed</a>,</div><div id="180" class="line none">  180     <a href="ota.h.html#180">JobStatusSucceeded</a>,</div><div id="181" class="line none">  181     <a href="ota.h.html#181">JobStatusRejected</a>,      /* Not possible today using the "get next job" feature. FUTURE! */</div><div id="182" class="line none">  182     <a href="ota.h.html#182">JobStatusFailedWithVal</a>, /* This shows 2 numeric reason codes. */</div><div id="183" class="line none">  183     <a href="ota.h.html#183">NumJobStatusMappings</a></div><div id="184" class="line none">  184 } <a href="ota.h.html#184">OtaJobStatus_t</a>;</div><div id="185" class="line none">  185 </div><div id="186" class="line none">  186 /**</div><div id="187" class="line none">  187  * @ingroup ota_struct_types</div><div id="188" class="line none">  188  * @brief OTA Job document.</div><div id="189" class="line none">  189  * @note This is provided as context to the app callback, #OtaAppCallback_t,</div><div id="190" class="line none">  190  * to provide information of a custom job that cannot be parsed.</div><div id="191" class="line none">  191  *</div><div id="192" class="line none">  192  * Structure representing OTA job document.</div><div id="193" class="line none">  193  */</div><div id="194" class="line none">  194 typedef struct <a href="ota.h.html#194">OtaJobDocument</a></div><div id="195" class="line none">  195 {</div><div id="196" class="line none">  196     const uint8_t * <a href="ota.h.html#196">pJobDocJson</a>; /*!&lt; @brief Job document in JSON format. */</div><div id="197" class="line none">  197     size_t <a href="ota.h.html#197">jobDocLength</a>;         /*!&lt; @brief Job document length in bytes. */</div><div id="198" class="line none">  198     const uint8_t * <a href="ota.h.html#198">pJobId</a>;      /*!&lt; @brief Job ID associated with the job document. */</div><div id="199" class="line none">  199     size_t <a href="ota.h.html#199">jobIdLength</a>;          /*!&lt; @brief Length of job ID in bytes. */</div><div id="200" class="line none">  200     uint32_t <a href="ota.h.html#200">fileTypeId</a>;         /*!&lt; @brief File Type ID from the job document. */</div><div id="201" class="line none">  201     <a href="ota.h.html#139">OtaJobParseErr_t</a> <a href="ota.h.html#201">parseErr</a>;   /*!&lt; @brief Job parsing status. */</div><div id="202" class="line none">  202     <a href="ota.h.html#184">OtaJobStatus_t</a> <a href="ota.h.html#202">status</a>;       /*!&lt; @brief Job status. */</div><div id="203" class="line none">  203     int32_t <a href="ota.h.html#203">reason</a>;              /*!&lt; @brief Job status reason. */</div><div id="204" class="line none">  204     int32_t <a href="ota.h.html#204">subReason</a>;           /*!&lt; @brief Job status subreason. */</div><div id="205" class="line none">  205 } <a href="ota.h.html#205">OtaJobDocument_t</a>;</div><div id="206" class="line none">  206 </div><div id="207" class="line none">  207 /*------------------------- OTA callbacks --------------------------*/</div><div id="208" class="line none">  208 </div><div id="209" class="line none">  209 /**</div><div id="210" class="line none">  210  * @ingroup ota_callback_types</div><div id="211" class="line none">  211  * @brief OTA update complete callback function typedef.</div><div id="212" class="line none">  212  *</div><div id="213" class="line none">  213  * The user must register a callback function when initializing the OTA Agent. This</div><div id="214" class="line none">  214  * callback is used to notify the main application when the OTA update job is complete.</div><div id="215" class="line none">  215  * Typically, it is used to reset the device after a successful update by calling</div><div id="216" class="line none">  216  * @ref OTA_ActivateNewImage and may also be used to kick off user specified self tests</div><div id="217" class="line none">  217  * during the Self Test phase.</div><div id="218" class="line none">  218  *</div><div id="219" class="line none">  219  * The callback function is called with one of the following arguments:</div><div id="220" class="line none">  220  *</div><div id="221" class="line none">  221  *      OtaJobEventActivate      OTA update is authenticated and ready to activate.</div><div id="222" class="line none">  222  *      OtaJobEventFail          OTA update failed. Unable to use this update.</div><div id="223" class="line none">  223  *      OtaJobEventStartTest     OTA job is now ready for optional user self tests.</div><div id="224" class="line none">  224  *</div><div id="225" class="line none">  225  * When OtaJobEventActivate is received, the job status details have been updated with</div><div id="226" class="line none">  226  * the state as ready for Self Test. After reboot, the new firmware will (normally) be</div><div id="227" class="line none">  227  * notified that it is in the Self Test phase via the callback and the application may</div><div id="228" class="line none">  228  * then optionally run its own tests before committing the new image.</div><div id="229" class="line none">  229  *</div><div id="230" class="line none">  230  * If the callback function is called with a result of OtaJobEventFail, the OTA update</div><div id="231" class="line none">  231  * job has failed in some way and should be rejected.</div><div id="232" class="line none">  232  *</div><div id="233" class="line none">  233  * @param[in] eEvent An OTA update event from the OtaJobEvent_t enum.</div><div id="234" class="line none">  234  *</div><div id="235" class="line none">  235  * @param[in] pData Optional data related to the event.</div><div id="236" class="line none">  236  */</div><div id="237" class="line none">  237 typedef void (* <a href="ota.h.html#237">OtaAppCallback_t</a>)( <a href="ota.h.html#169">OtaJobEvent_t</a> eEvent,</div><div id="238" class="line none">  238                                    const void * pData );</div><div id="239" class="line none">  239 </div><div id="240" class="line none">  240 /*--------------------------- OTA structs ----------------------------*/</div><div id="241" class="line none">  241 </div><div id="242" class="line none">  242 </div><div id="243" class="line none">  243 /**</div><div id="244" class="line none">  244  * @ingroup ota_struct_types</div><div id="245" class="line none">  245  * @brief OTA Interface for referencing different components.</div><div id="246" class="line none">  246  *</div><div id="247" class="line none">  247  * Information about the different interfaces used to initialize</div><div id="248" class="line none">  248  * the OTA agent with references to components.</div><div id="249" class="line none">  249  */</div><div id="250" class="line none">  250 typedef struct <a href="ota.h.html#250">OtaInterface</a></div><div id="251" class="line none">  251 {</div><div id="252" class="line none">  252     <a href="ota_os_interface.h.html#299">OtaOSInterface_t</a> <a href="ota.h.html#252">os</a>;     /*!&lt; @brief OS interface to store event, timers and memory operations. */</div><div id="253" class="line none">  253     <a href="ota_mqtt_interface.h.html#160">OtaMqttInterface_t</a> <a href="ota.h.html#253">mqtt</a>; /*!&lt; @brief MQTT interface that references the publish subscribe methods and callbacks. */</div><div id="254" class="line none">  254     <a href="ota_http_interface.h.html#134">OtaHttpInterface_t</a> <a href="ota.h.html#254">http</a>; /*!&lt; @brief HTTP interface to request data. */</div><div id="255" class="line none">  255     <a href="ota_platform_interface.h.html#305">OtaPalInterface_t</a> <a href="ota.h.html#255">pal</a>;   /*!&lt; @brief OTA PAL callback structure. */</div><div id="256" class="line none">  256 } <a href="ota.h.html#256">OtaInterfaces_t</a>;</div><div id="257" class="line none">  257 </div><div id="258" class="line none">  258 /**</div><div id="259" class="line none">  259  * @ingroup ota_struct_types</div><div id="260" class="line none">  260  * @brief OTA Application Buffer size information.</div><div id="261" class="line none">  261  *</div><div id="262" class="line none">  262  * File key signature information to verify the authenticity of the incoming file</div><div id="263" class="line none">  263  */</div><div id="264" class="line none">  264 typedef struct <a href="ota.h.html#264">OtaAppBuffer</a></div><div id="265" class="line none">  265 {</div><div id="266" class="line none">  266     uint8_t * <a href="ota.h.html#266">pUpdateFilePath</a>;   /*!&lt; @brief Path to store the files. */</div><div id="267" class="line none">  267     uint16_t <a href="ota.h.html#267">updateFilePathsize</a>; /*!&lt; @brief Maximum size of the file path. */</div><div id="268" class="line none">  268     uint8_t * <a href="ota.h.html#268">pCertFilePath</a>;     /*!&lt; @brief Path to certificate file. */</div><div id="269" class="line none">  269     uint16_t <a href="ota.h.html#269">certFilePathSize</a>;   /*!&lt; @brief Maximum size of the certificate file path. */</div><div id="270" class="line none">  270     uint8_t * <a href="ota.h.html#270">pStreamName</a>;       /*!&lt; @brief Name of stream to download the files. */</div><div id="271" class="line none">  271     uint16_t <a href="ota.h.html#271">streamNameSize</a>;     /*!&lt; @brief Maximum size of the stream name. */</div><div id="272" class="line none">  272     uint8_t * <a href="ota.h.html#272">pDecodeMemory</a>;     /*!&lt; @brief Place to store the decoded files. */</div><div id="273" class="line none">  273     uint32_t <a href="ota.h.html#273">decodeMemorySize</a>;   /*!&lt; @brief Maximum size of the decoded files buffer. */</div><div id="274" class="line none">  274     uint8_t * <a href="ota.h.html#274">pFileBitmap</a>;       /*!&lt; @brief Bitmap of the parameters received. */</div><div id="275" class="line none">  275     uint16_t <a href="ota.h.html#275">fileBitmapSize</a>;     /*!&lt; @brief Maximum size of the bitmap. */</div><div id="276" class="line none">  276     uint8_t * <a href="ota.h.html#276">pUrl</a>;              /*!&lt; @brief Presigned url to download files from S3. */</div><div id="277" class="line none">  277     uint16_t <a href="ota.h.html#277">urlSize</a>;            /*!&lt; @brief Maximum size of the URL. */</div><div id="278" class="line none">  278     uint8_t * <a href="ota.h.html#278">pAuthScheme</a>;       /*!&lt; @brief Authentication scheme used to validate download. */</div><div id="279" class="line none">  279     uint16_t <a href="ota.h.html#279">authSchemeSize</a>;     /*!&lt; @brief Maximum size of the auth scheme. */</div><div id="280" class="line none">  280 } <a href="ota.h.html#280">OtaAppBuffer_t</a>;</div><div id="281" class="line none">  281 </div><div id="282" class="line none">  282 /**</div><div id="283" class="line none">  283  * @ingroup ota_private_struct_types</div><div id="284" class="line none">  284  * @brief  The OTA agent is a singleton today. The structure keeps it nice and organized.</div><div id="285" class="line none">  285  */</div><div id="286" class="line none">  286 </div><div id="287" class="line none">  287 typedef struct <a href="ota.h.html#287">OtaAgentContext</a></div><div id="288" class="line none">  288 {</div><div id="289" class="line none">  289     <a href="ota.h.html#122">OtaState_t</a> <a href="ota.h.html#289">state</a>;                                      /*!&lt; State of the OTA agent. */</div><div id="290" class="line none">  290     uint8_t <a href="ota.h.html#290">pThingName</a>[ otaconfigMAX_THINGNAME_LEN + 1U ]; /*!&lt; Thing name + zero terminator. */</div><div id="291" class="line none">  291     <a href="ota_private.h.html#408">OtaFileContext_t</a> <a href="ota.h.html#291">fileContext</a>;                          /*!&lt; Static array of OTA file structures. */</div><div id="292" class="line none">  292     uint32_t <a href="ota.h.html#292">fileIndex</a>;                                    /*!&lt; Index of current file in the array. */</div><div id="293" class="line none">  293     uint32_t <a href="ota.h.html#293">serverFileID</a>;                                 /*!&lt; Variable to store current file ID passed down */</div><div id="294" class="line none">  294     uint8_t <a href="ota.h.html#294">pActiveJobName</a>[ <a href="ota_private.h.html#103">OTA_JOB_ID_MAX_SIZE</a> ];         /*!&lt; The currently active job name. We only allow one at a time. */</div><div id="295" class="line none">  295     uint8_t * <a href="ota.h.html#295">pClientTokenFromJob</a>;                         /*!&lt; The clientToken field from the latest update job. */</div><div id="296" class="line none">  296     uint32_t <a href="ota.h.html#296">timestampFromJob</a>;                             /*!&lt; Timestamp received from the latest job document. */</div><div id="297" class="line none">  297     <a href="ota_private.h.html#316">OtaImageState_t</a> <a href="ota.h.html#297">imageState</a>;                            /*!&lt; The current application image state. */</div><div id="298" class="line none">  298     uint32_t <a href="ota.h.html#298">numOfBlocksToReceive</a>;                         /*!&lt; Number of data blocks to receive per data request. */</div><div id="299" class="line none">  299     <a href="ota_private.h.html#290">OtaAgentStatistics_t</a> <a href="ota.h.html#299">statistics</a>;                       /*!&lt; The OTA agent statistics block. */</div><div id="300" class="line none">  300     uint32_t <a href="ota.h.html#300">requestMomentum</a>;                              /*!&lt; The number of requests sent before a response was received. */</div><div id="301" class="line none">  301     const <a href="ota.h.html#256">OtaInterfaces_t</a> * <a href="ota.h.html#301">pOtaInterface</a>;                 /*!&lt; Collection of all interfaces used by the agent. */</div><div id="302" class="line none">  302     <a href="ota.h.html#237">OtaAppCallback_t</a> <a href="ota.h.html#302">OtaAppCallback</a>;                       /*!&lt; OTA App callback. */</div><div id="303" class="line none">  303     uint8_t <a href="ota.h.html#303">unsubscribeOnShutdown</a>;                         /*!&lt; Flag to indicate if unsubscribe from job topics should be done at shutdown. */</div><div id="304" class="line none">  304 } <a href="ota.h.html#304">OtaAgentContext_t</a>;</div><div id="305" class="line none">  305 </div><div id="306" class="line none">  306 /*------------------------- OTA Public API --------------------------*/</div><div id="307" class="line none">  307 </div><div id="308" class="line none">  308 /**</div><div id="309" class="line none">  309  * @brief OTA Agent initialization function.</div><div id="310" class="line none">  310  *</div><div id="311" class="line none">  311  * Initialize the OTA engine by starting the OTA Agent ("OTA Task") in the system. This function must</div><div id="312" class="line none">  312  * be called with the connection client context before calling @ref OTA_CheckForUpdate. Only one</div><div id="313" class="line none">  313  * OTA Agent may exist.</div><div id="314" class="line none">  314  *</div><div id="315" class="line none">  315  * @param[in] pOtaBuffer Buffers used by the agent to store different params.</div><div id="316" class="line none">  316  * @param[in] pOtaInterfaces A pointer to the OS context.</div><div id="317" class="line none">  317  * @param[in] pThingName A pointer to a C string holding the Thing name.</div><div id="318" class="line none">  318  * @param[in] OtaAppCallback Static callback function for when an OTA job is complete. This function will have</div><div id="319" class="line none">  319  * input of the state of the OTA image after download and during self-test.</div><div id="320" class="line none">  320  * @return OtaErr_t The state of the OTA Agent upon return from the OtaState_t enum.</div><div id="321" class="line none">  321  * If the agent was successfully initialized and ready to operate, the state will be</div><div id="322" class="line none">  322  * OtaAgentStateReady. Otherwise, it will be one of the other OtaState_t enum values.</div><div id="323" class="line none">  323  *</div><div id="324" class="line none">  324  * &lt;b&gt;Example&lt;/b&gt;</div><div id="325" class="line none">  325  * @code{c}</div><div id="326" class="line none">  326  * // Application callback when the OTA agent has completed the job</div><div id="327" class="line none">  327  * // or is in self test mode. For example see [demos](https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/main/demos/ota)</div><div id="328" class="line none">  328  * void otaAppCallback( OtaJobEvent_t event,</div><div id="329" class="line none">  329  *                      const void * pData );</div><div id="330" class="line none">  330  *</div><div id="331" class="line none">  331  * // Optional: User buffer to pass down to the OTA Agent. These</div><div id="332" class="line none">  332  * // buffers are assumed to be initialized previously, example:</div><div id="333" class="line none">  333  * // uint8_t updateFilePath[ OTA_MAX_FILE_PATH_SIZE ];</div><div id="334" class="line none">  334  * OtaAppBuffer_t otaBuffer =</div><div id="335" class="line none">  335  * {</div><div id="336" class="line none">  336  *     .pUpdateFilePath    = updateFilePath,</div><div id="337" class="line none">  337  *     .updateFilePathsize = OTA_MAX_FILE_PATH_SIZE,</div><div id="338" class="line none">  338  *     .pCertFilePath      = certFilePath,</div><div id="339" class="line none">  339  *     .certFilePathSize   = OTA_MAX_FILE_PATH_SIZE,</div><div id="340" class="line none">  340  *     .pDecodeMemory      = decodeMem,</div><div id="341" class="line none">  341  *     .decodeMemorySize   = otaconfigFILE_BLOCK_SIZE,</div><div id="342" class="line none">  342  *     .pFileBitmap        = bitmap,</div><div id="343" class="line none">  343  *     .fileBitmapSize     = OTA_MAX_BLOCK_BITMAP_SIZE,</div><div id="344" class="line none">  344  *     .pUrl               = updateUrl,</div><div id="345" class="line none">  345  *     .urlSize            = OTA_MAX_URL_SIZE,</div><div id="346" class="line none">  346  *     .pAuthScheme        = authScheme,</div><div id="347" class="line none">  347  *     .authSchemeSize     = OTA_MAX_AUTH_SCHEME_SIZE</div><div id="348" class="line none">  348  * };</div><div id="349" class="line none">  349  *</div><div id="350" class="line none">  350  * // OTA interface context required for library interface functions</div><div id="351" class="line none">  351  * // The functions set by these interfaces are assumed to be defined</div><div id="352" class="line none">  352  * // For more information see [demos](https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/main/demos/ota)</div><div id="353" class="line none">  353  * OtaInterfaces_t pOtaInterfaces =</div><div id="354" class="line none">  354  * {</div><div id="355" class="line none">  355  *     // Initialize OTA library OS Interface.</div><div id="356" class="line none">  356  *     .os.event.init = Posix_OtaInitEvent;</div><div id="357" class="line none">  357  *     .os.event.send = Posix_OtaSendEvent;</div><div id="358" class="line none">  358  *     ...</div><div id="359" class="line none">  359  *     // Initialize the OTA library MQTT Interface.</div><div id="360" class="line none">  360  *     .mqtt.subscribe = mqttSubscribe;</div><div id="361" class="line none">  361  *     .mqtt.publish = mqttPublish;</div><div id="362" class="line none">  362  *     .mqtt.unsubscribe = mqttUnsubscribe;</div><div id="363" class="line none">  363  *     // Initialize the OTA library HTTP Interface.</div><div id="364" class="line none">  364  *     .http.init = httpInit;</div><div id="365" class="line none">  365  *     .http.request = httpRequest;</div><div id="366" class="line none">  366  *     .http.deinit = httpDeinit;</div><div id="367" class="line none">  367  *     // Initialize the OTA library PAL Interface.</div><div id="368" class="line none">  368  *     .pal.getPlatformImageState = otaPal_GetPlatformImageState;</div><div id="369" class="line none">  369  *     .pal.setPlatformImageState = otaPal_SetPlatformImageState;</div><div id="370" class="line none">  370  * }</div><div id="371" class="line none">  371  *</div><div id="372" class="line none">  372  * // OTA library error status.</div><div id="373" class="line none">  373  * OtaErr_t otaErr = OtaErrNone;</div><div id="374" class="line none">  374  *</div><div id="375" class="line none">  375  * // Unique client identifier</div><div id="376" class="line none">  376  * char * pClientIdentifier = "uniqueClientID";</div><div id="377" class="line none">  377  *</div><div id="378" class="line none">  378  * otaErr = OTA_Init( &amp;otaBuffer,</div><div id="379" class="line none">  379  *                    &amp;otaInterfaces,</div><div id="380" class="line none">  380  *                    ( const uint8_t * ) pClientIdentifier,</div><div id="381" class="line none">  381  *                    otaAppCallback ) ) != OtaErrNone )</div><div id="382" class="line none">  382  *          if( otaErr == OtaErrNone )</div><div id="383" class="line none">  383  * {</div><div id="384" class="line none">  384  *     // Do something with the OTA agent.</div><div id="385" class="line none">  385  * }</div><div id="386" class="line none">  386  * @endcode</div><div id="387" class="line none">  387  */</div><div id="388" class="line none">  388 /* @[declare_ota_init] */</div><div id="389" class="line none">  389 <a href="ota.h.html#97">OtaErr_t</a> OTA_Init( <a href="ota.h.html#280">OtaAppBuffer_t</a> * pOtaBuffer,</div><div id="390" class="line none">  390                    const <a href="ota.h.html#256">OtaInterfaces_t</a> * pOtaInterfaces,</div><div id="391" class="line none">  391                    const uint8_t * <a href="ota.h.html#290">pThingName</a>,</div><div id="392" class="line none">  392                    <a href="ota.h.html#237">OtaAppCallback_t</a> <a href="ota.h.html#302">OtaAppCallback</a> );</div><div id="393" class="line none">  393 /* @[declare_ota_init] */</div><div id="394" class="line none">  394 </div><div id="395" class="line none">  395 /**</div><div id="396" class="line none">  396  * @brief Signal to the OTA Agent to shut down.</div><div id="397" class="line none">  397  *</div><div id="398" class="line none">  398  * Signals the OTA agent task to shut down. The OTA agent will unsubscribe from all MQTT job</div><div id="399" class="line none">  399  * notification topics, stop in progress OTA jobs, if any, and clear all resources.</div><div id="400" class="line none">  400  *</div><div id="401" class="line none">  401  * @param[in] ticksToWait The number of ticks to wait for the OTA Agent to complete the shutdown process.</div><div id="402" class="line none">  402  * If this is set to zero, the function will return immediately without waiting. The actual state is</div><div id="403" class="line none">  403  * returned to the caller. The agent does not sleep for this while but used for busy looping.</div><div id="404" class="line none">  404  *</div><div id="405" class="line none">  405  * @param[in] unsubscribeFlag Flag to indicate if unsubscribe operations should be performed from the job topics when</div><div id="406" class="line none">  406  * shutdown is called. If the flag is 0 then unsubscribe operations are not called for job topics If application</div><div id="407" class="line none">  407  * requires it to be unsubscribed from the job topics then flag must be set to 1 when calling OTA_Shutdown.</div><div id="408" class="line none">  408  *</div><div id="409" class="line none">  409  * @return One of the OTA agent states from the OtaState_t enum.</div><div id="410" class="line none">  410  * A normal shutdown will return OtaAgentStateNotReady. Otherwise, refer to the OtaState_t enum for details.</div><div id="411" class="line none">  411  *</div><div id="412" class="line none">  412  * &lt;b&gt;Example&lt;/b&gt;</div><div id="413" class="line none">  413  * @code{c}</div><div id="414" class="line none">  414  * // ticksToWait used for busy looping until shutdown. Actual delay may depend on the agent priority,</div><div id="415" class="line none">  415  * // and platform.</div><div id="416" class="line none">  416  * uint32_t ticksToWait = 100;</div><div id="417" class="line none">  417  *</div><div id="418" class="line none">  418  * // If it is required that the unsubscribe operations are not</div><div id="419" class="line none">  419  * //performed while shutting down set this to 0.</div><div id="420" class="line none">  420  * uint8_t unsubscribe = 1;</div><div id="421" class="line none">  421  *</div><div id="422" class="line none">  422  * OTA_Shutdown(ticksToWait, unsubscribe);</div><div id="423" class="line none">  423  * ...</div><div id="424" class="line none">  424  *</div><div id="425" class="line none">  425  * if( OTA_GetState() != OtaAgentStateStopped )</div><div id="426" class="line none">  426  * {</div><div id="427" class="line none">  427  *     // Optional: Disconnect MQTT and HTTP connections</div><div id="428" class="line none">  428  *     // required by the OTA agent and other tasks.</div><div id="429" class="line none">  429  * }</div><div id="430" class="line none">  430  * @endcode</div><div id="431" class="line none">  431  */</div><div id="432" class="line none">  432 /* @[declare_ota_shutdown] */</div><div id="433" class="line none">  433 <a href="ota.h.html#122">OtaState_t</a> OTA_Shutdown( uint32_t ticksToWait,</div><div id="434" class="line none">  434                          uint8_t unsubscribeFlag );</div><div id="435" class="line none">  435 /* @[declare_ota_shutdown] */</div><div id="436" class="line none">  436 </div><div id="437" class="line none">  437 /**</div><div id="438" class="line none">  438  * @brief Get the current state of the OTA agent.</div><div id="439" class="line none">  439  *</div><div id="440" class="line none">  440  * @return The current state of the OTA agent.</div><div id="441" class="line none">  441  *</div><div id="442" class="line none">  442  * &lt;b&gt;Example&lt;/b&gt;</div><div id="443" class="line none">  443  * Check if OTA agent is in suspended state.</div><div id="444" class="line none">  444  * @code{c}</div><div id="445" class="line none">  445  * // OTA Agent state</div><div id="446" class="line none">  446  * OtaState_t state = OTA_GetState();</div><div id="447" class="line none">  447  *</div><div id="448" class="line none">  448  * while( state != OtaAgentStateSuspended )</div><div id="449" class="line none">  449  * {</div><div id="450" class="line none">  450  *     // Do something while the agent is back to</div><div id="451" class="line none">  451  *     // the desired state.</div><div id="452" class="line none">  452  *     state = OTA_GetState();</div><div id="453" class="line none">  453  * }</div><div id="454" class="line none">  454  * @endcode</div><div id="455" class="line none">  455  */</div><div id="456" class="line none">  456 /* @[declare_ota_getstate] */</div><div id="457" class="line none">  457 <a href="ota.h.html#122">OtaState_t</a> OTA_GetState( void );</div><div id="458" class="line none">  458 /* @[declare_ota_getstate] */</div><div id="459" class="line none">  459 </div><div id="460" class="line none">  460 /**</div><div id="461" class="line none">  461  * @brief Activate the newest MCU image received via OTA.</div><div id="462" class="line none">  462  *</div><div id="463" class="line none">  463  * This function should reset the MCU and cause a reboot of the system to execute the newly updated</div><div id="464" class="line none">  464  * firmware. It should be called by the user code sometime after the OtaJobEventActivate event</div><div id="465" class="line none">  465  * is passed to the users application via the OTA Job Complete Callback mechanism. Refer to the</div><div id="466" class="line none">  466  * @ref OTA_Init function for more information about configuring the callback.</div><div id="467" class="line none">  467  *</div><div id="468" class="line none">  468  * @return OtaErrNone if successful, otherwise an error code prefixed with 'OtaErr' from the</div><div id="469" class="line none">  469  * list above.</div><div id="470" class="line none">  470  *</div><div id="471" class="line none">  471  * &lt;b&gt;Example&lt;/b&gt;</div><div id="472" class="line none">  472  * @code{c}</div><div id="473" class="line none">  473  * static void otaAppCallback( OtaJobEvent_t event,</div><div id="474" class="line none">  474  *                             const void * pData )</div><div id="475" class="line none">  475  * {</div><div id="476" class="line none">  476  *     OtaErr_t otaErr = OtaErrNone;</div><div id="477" class="line none">  477  *     if( event == OtaJobEventActivate )</div><div id="478" class="line none">  478  *     {</div><div id="479" class="line none">  479  *         // Activate the new firmware image.</div><div id="480" class="line none">  480  *         // This calls the platform specific code required to</div><div id="481" class="line none">  481  *         // activate the received OTA update firmware.</div><div id="482" class="line none">  482  *         otaErr = OTA_ActivateNewImage();</div><div id="483" class="line none">  483  *         if( otaErr == OtaErrActivateFailed )</div><div id="484" class="line none">  484  *         {</div><div id="485" class="line none">  485  *              // Handle Image activation failure by requesting manual response, sending</div><div id="486" class="line none">  486  *              // error logs or retrying activation.</div><div id="487" class="line none">  487  *         }</div><div id="488" class="line none">  488  *     }</div><div id="489" class="line none">  489  *</div><div id="490" class="line none">  490  *     // Handle other events</div><div id="491" class="line none">  491  * }</div><div id="492" class="line none">  492  * @endcode</div><div id="493" class="line none">  493  */</div><div id="494" class="line none">  494 /* @[declare_ota_activatenewimage] */</div><div id="495" class="line none">  495 <a href="ota.h.html#97">OtaErr_t</a> OTA_ActivateNewImage( void );</div><div id="496" class="line none">  496 /* @[declare_ota_activatenewimage] */</div><div id="497" class="line none">  497 </div><div id="498" class="line none">  498 /**</div><div id="499" class="line none">  499  * @brief Set the state of the current MCU image.</div><div id="500" class="line none">  500  *</div><div id="501" class="line none">  501  * The states are OtaImageStateTesting, OtaImageStateAccepted, OtaImageStateAborted or</div><div id="502" class="line none">  502  * OtaImageStateRejected; see OtaImageState_t documentation. This will update the status of the</div><div id="503" class="line none">  503  * current image and publish to the active job status topic.</div><div id="504" class="line none">  504  *</div><div id="505" class="line none">  505  * @param[in] state The state to set of the OTA image.</div><div id="506" class="line none">  506  *</div><div id="507" class="line none">  507  * @return OtaErrNone if successful, otherwise an error code prefixed with 'OtaErr' from the</div><div id="508" class="line none">  508  * list above.</div><div id="509" class="line none">  509  *</div><div id="510" class="line none">  510  * &lt;b&gt;Example&lt;/b&gt;</div><div id="511" class="line none">  511  * Set image state to reflect new image is accepted in application callback.</div><div id="512" class="line none">  512  *</div><div id="513" class="line none">  513  * @code{c}</div><div id="514" class="line none">  514  * static void otaAppCallback( OtaJobEvent_t event,</div><div id="515" class="line none">  515  *                             const void * pData )</div><div id="516" class="line none">  516  * {</div><div id="517" class="line none">  517  *     OtaErr_t otaErr = OtaErrNone;</div><div id="518" class="line none">  518  *</div><div id="519" class="line none">  519  *     if( event == OtaJobEventStartTest )</div><div id="520" class="line none">  520  *     {</div><div id="521" class="line none">  521  *         err = OTA_SetImageState( OtaImageStateAccepted );</div><div id="522" class="line none">  522  *         if( err != OtaErrNone )</div><div id="523" class="line none">  523  *         {</div><div id="524" class="line none">  524  *             // Handle failure or retry setting the image state.</div><div id="525" class="line none">  525  *         }</div><div id="526" class="line none">  526  *     }</div><div id="527" class="line none">  527  *</div><div id="528" class="line none">  528  *     // Handle other events</div><div id="529" class="line none">  529  * }</div><div id="530" class="line none">  530  * @endcode</div><div id="531" class="line none">  531  */</div><div id="532" class="line none">  532 /* @[declare_ota_setimagestate] */</div><div id="533" class="line none">  533 <a href="ota.h.html#97">OtaErr_t</a> OTA_SetImageState( <a href="ota_private.h.html#316">OtaImageState_t</a> <a href="ota.h.html#289">state</a> );</div><div id="534" class="line none">  534 /* @[declare_ota_setimagestate] */</div><div id="535" class="line none">  535 </div><div id="536" class="line none">  536 /**</div><div id="537" class="line none">  537  * @brief Get the state of the currently running MCU image.</div><div id="538" class="line none">  538  *</div><div id="539" class="line none">  539  * The states are OtaImageStateTesting, OtaImageStateAccepted, OtaImageStateAborted or</div><div id="540" class="line none">  540  * OtaImageStateRejected; see OtaImageState_t documentation.</div><div id="541" class="line none">  541  *</div><div id="542" class="line none">  542  * @return The state of the current context's OTA image.</div><div id="543" class="line none">  543  */</div><div id="544" class="line none">  544 /* @[declare_ota_getimagestate] */</div><div id="545" class="line none">  545 <a href="ota_private.h.html#316">OtaImageState_t</a> OTA_GetImageState( void );</div><div id="546" class="line none">  546 /* @[declare_ota_getimagestate] */</div><div id="547" class="line none">  547 </div><div id="548" class="line none">  548 /**</div><div id="549" class="line none">  549  * @brief Request for the next available OTA job from the job service.</div><div id="550" class="line none">  550  *</div><div id="551" class="line none">  551  * @return OtaErrNone if successful, otherwise an error code prefixed with 'OtaErr' from the</div><div id="552" class="line none">  552  * list above.</div><div id="553" class="line none">  553  */</div><div id="554" class="line none">  554 /* @[declare_ota_checkforupdate] */</div><div id="555" class="line none">  555 <a href="ota.h.html#97">OtaErr_t</a> OTA_CheckForUpdate( void );</div><div id="556" class="line none">  556 /* @[declare_ota_checkforupdate] */</div><div id="557" class="line none">  557 </div><div id="558" class="line none">  558 /**</div><div id="559" class="line none">  559  * @brief Suspend OTA agent operations .</div><div id="560" class="line none">  560  *</div><div id="561" class="line none">  561  * @return OtaErrNone if successful, otherwise an error code prefixed with 'OtaErr' from the</div><div id="562" class="line none">  562  * list above.</div><div id="563" class="line none">  563  *</div><div id="564" class="line none">  564  * &lt;b&gt;Example&lt;/b&gt;</div><div id="565" class="line none">  565  * Suspend the OTA agent when a network error occurs.</div><div id="566" class="line none">  566  * @code{c}</div><div id="567" class="line none">  567  * void handleNetworkErrors()</div><div id="568" class="line none">  568  * {</div><div id="569" class="line none">  569  *     OtaErr_t otaErr = OtaErrNone;</div><div id="570" class="line none">  570  *     int16_t suspendTimeout = 5000U;</div><div id="571" class="line none">  571  *</div><div id="572" class="line none">  572  *     // Handle disconnects and other network reset operations</div><div id="573" class="line none">  573  *</div><div id="574" class="line none">  574  *     // Suspend OTA operations.</div><div id="575" class="line none">  575  *     otaErr = OTA_Suspend();</div><div id="576" class="line none">  576  *</div><div id="577" class="line none">  577  *     if( otaErr != OtaErrNone )</div><div id="578" class="line none">  578  *     {</div><div id="579" class="line none">  579  *         // Suspend may fail due to Event queue failure,</div><div id="580" class="line none">  580  *         // or if the agent has shut down, handle the failure by</div><div id="581" class="line none">  581  *         // sending logs or retrying OTA_Suspend().</div><div id="582" class="line none">  582  *     }</div><div id="583" class="line none">  583  *     else</div><div id="584" class="line none">  584  *     {</div><div id="585" class="line none">  585  *         while( ( ( OTA_GetState() != OtaAgentStateSuspended )</div><div id="586" class="line none">  586  *                 &amp;&amp; ( suspendTimeout &gt; 0 ) )</div><div id="587" class="line none">  587  *         {</div><div id="588" class="line none">  588  *             // Wait for OTA Library state to suspend</div><div id="589" class="line none">  589  *             portSleep( 1000U );</div><div id="590" class="line none">  590  *             suspendTimeout -= 1000U;</div><div id="591" class="line none">  591  *         }</div><div id="592" class="line none">  592  *         if( OTA_GetState() != OtaAgentStateSuspended )</div><div id="593" class="line none">  593  *         {</div><div id="594" class="line none">  594  *             // Handle Suspend failure or Retry OTA_Suspend().</div><div id="595" class="line none">  595  *         }</div><div id="596" class="line none">  596  *     }</div><div id="597" class="line none">  597  * }</div><div id="598" class="line none">  598  * @endcode</div><div id="599" class="line none">  599  */</div><div id="600" class="line none">  600 /* @[declare_ota_suspend] */</div><div id="601" class="line none">  601 <a href="ota.h.html#97">OtaErr_t</a> OTA_Suspend( void );</div><div id="602" class="line none">  602 /* @[declare_ota_suspend] */</div><div id="603" class="line none">  603 </div><div id="604" class="line none">  604 /**</div><div id="605" class="line none">  605  * @brief Resume OTA agent operations .</div><div id="606" class="line none">  606  *</div><div id="607" class="line none">  607  * @return OtaErrNone if successful, otherwise an error code prefixed with 'OtaErr' from the</div><div id="608" class="line none">  608  * list above.</div><div id="609" class="line none">  609  *</div><div id="610" class="line none">  610  * &lt;b&gt;Example&lt;/b&gt;</div><div id="611" class="line none">  611  * Resume the OTA agent after the network errors are resolved.</div><div id="612" class="line none">  612  * @code{c}</div><div id="613" class="line none">  613  * bool handleReconnect()</div><div id="614" class="line none">  614  * {</div><div id="615" class="line none">  615  *     // OTA event message used for sending event to OTA Agent.</div><div id="616" class="line none">  616  *     OtaEventMsg_t eventMsg = { 0 };</div><div id="617" class="line none">  617  *     OtaErr_t otaErr = OtaErrUninitialized;</div><div id="618" class="line none">  618  *     bool returnStatus = establishConnection();</div><div id="619" class="line none">  619  *</div><div id="620" class="line none">  620  *     if( returnStatus == EXIT_SUCCESS )</div><div id="621" class="line none">  621  *     {</div><div id="622" class="line none">  622  *         // Check if OTA process was suspended and resume if required.</div><div id="623" class="line none">  623  *         if( OTA_GetState() == OtaAgentStateSuspended )</div><div id="624" class="line none">  624  *         {</div><div id="625" class="line none">  625  *             // Resume OTA operations.</div><div id="626" class="line none">  626  *             otaErr = OTA_Resume();</div><div id="627" class="line none">  627  *         }</div><div id="628" class="line none">  628  *         else</div><div id="629" class="line none">  629  *         {</div><div id="630" class="line none">  630  *             // Send start event to OTA Agent.</div><div id="631" class="line none">  631  *             eventMsg.eventId = OtaAgentEventStart;</div><div id="632" class="line none">  632  *             OTA_SignalEvent( &amp;eventMsg );</div><div id="633" class="line none">  633  *         }</div><div id="634" class="line none">  634  *</div><div id="635" class="line none">  635  *         if( otaErr != OtaErrNone )</div><div id="636" class="line none">  636  *             returnStatus = false;</div><div id="637" class="line none">  637  *     }</div><div id="638" class="line none">  638  *</div><div id="639" class="line none">  639  *     return returnStatus;</div><div id="640" class="line none">  640  * }</div><div id="641" class="line none">  641  * @endcode</div><div id="642" class="line none">  642  */</div><div id="643" class="line none">  643 /* @[declare_ota_resume] */</div><div id="644" class="line none">  644 <a href="ota.h.html#97">OtaErr_t</a> OTA_Resume( void );</div><div id="645" class="line none">  645 /* @[declare_ota_resume] */</div><div id="646" class="line none">  646 </div><div id="647" class="line none">  647 /**</div><div id="648" class="line none">  648  * @brief OTA agent event processing loop.</div><div id="649" class="line none">  649  *</div><div id="650" class="line none">  650  * This is the main event loop to handle events for OTA update and needs to be called by</div><div id="651" class="line none">  651  * the application task. This loop will continue to handle and execute events received for</div><div id="652" class="line none">  652  * OTA Update until this tasks is terminated by the application.</div><div id="653" class="line none">  653  *</div><div id="654" class="line none">  654  * @param[in] pUnused Can be used to pass down functionality to the agent task, Unused for now.</div><div id="655" class="line none">  655  * This can be a function pointer that executes as the first routine when the</div><div id="656" class="line none">  656  * event loop starts.</div><div id="657" class="line none">  657  *</div><div id="658" class="line none">  658  * For a Posix based reference of creating a thread with this task,</div><div id="659" class="line none">  659  * please see the [demos in AWS IoT Embedded C SDK repository](https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/main/demos/ota).</div><div id="660" class="line none">  660  */</div><div id="661" class="line none">  661 /* @[declare_ota_eventprocessingtask] */</div><div id="662" class="line none">  662 void OTA_EventProcessingTask( void * pUnused );</div><div id="663" class="line none">  663 /* @[declare_ota_eventprocessingtask] */</div><div id="664" class="line none">  664 </div><div id="665" class="line none">  665 </div><div id="666" class="line none">  666 /**</div><div id="667" class="line none">  667  * @brief Signal event to the OTA Agent task.</div><div id="668" class="line none">  668  *</div><div id="669" class="line none">  669  * This function adds the event to the back of event queue and used</div><div id="670" class="line none">  670  * by internal OTA modules to signal agent task.</div><div id="671" class="line none">  671  *</div><div id="672" class="line none">  672  * @param[in] pEventMsg Event to be added to the queue</div><div id="673" class="line none">  673  * @return true If operation is successful, false If the event can not be added</div><div id="674" class="line none">  674  *</div><div id="675" class="line none">  675  * &lt;b&gt;Example&lt;/b&gt;</div><div id="676" class="line none">  676  * Signal OTA agent that a new file block has been received over the http connection.</div><div id="677" class="line none">  677  * @code{c}</div><div id="678" class="line none">  678  * OtaHttpStatus_t handleDataFromHTTPService( const HTTPResponse_t * pResponse )</div><div id="679" class="line none">  679  * {</div><div id="680" class="line none">  680  *     // Assume otaEventBufferGet is a user defined, thread-safe function</div><div id="681" class="line none">  681  *     // that gets an available buffer from the pool of OTA buffers.</div><div id="682" class="line none">  682  *     OtaEventData_t * pData = otaEventBufferGet();</div><div id="683" class="line none">  683  *     OtaHttpStatus_t returnValue = OtaHttpRequestFailed;</div><div id="684" class="line none">  684  *     bool result = false;</div><div id="685" class="line none">  685  *</div><div id="686" class="line none">  686  *     // Validate pResponse for correct data.</div><div id="687" class="line none">  687  *</div><div id="688" class="line none">  688  *     if( pData != NULL )</div><div id="689" class="line none">  689  *     {</div><div id="690" class="line none">  690  *         memcpy( pData-&gt;data, pResponse-&gt;pBody, pResponse-&gt;bodyLen );</div><div id="691" class="line none">  691  *         pData-&gt;dataLength = pResponse-&gt;bodyLen;</div><div id="692" class="line none">  692  *</div><div id="693" class="line none">  693  *         // Send job document received event.</div><div id="694" class="line none">  694  *         eventMsg.eventId = OtaAgentEventReceivedFileBlock;</div><div id="695" class="line none">  695  *         eventMsg.pEventData = pData;</div><div id="696" class="line none">  696  *         result = OTA_SignalEvent( &amp;eventMsg );</div><div id="697" class="line none">  697  *</div><div id="698" class="line none">  698  *         if( result )</div><div id="699" class="line none">  699  *         {</div><div id="700" class="line none">  700  *             returnValue = OtaHttpSuccess;</div><div id="701" class="line none">  701  *         }</div><div id="702" class="line none">  702  *     }</div><div id="703" class="line none">  703  *     return returnValue;</div><div id="704" class="line none">  704  * }</div><div id="705" class="line none">  705  * @endcode</div><div id="706" class="line none">  706  */</div><div id="707" class="line none">  707 /* @[declare_ota_signalevent] */</div><div id="708" class="line none">  708 bool OTA_SignalEvent( const <a href="ota_private.h.html#431">OtaEventMsg_t</a> * const pEventMsg );</div><div id="709" class="line none">  709 /* @[declare_ota_signalevent] */</div><div id="710" class="line none">  710 </div><div id="711" class="line none">  711 /*---------------------------------------------------------------------------*/</div><div id="712" class="line none">  712 /*                                                      Statistics API                                                                   */</div><div id="713" class="line none">  713 /*---------------------------------------------------------------------------*/</div><div id="714" class="line none">  714 </div><div id="715" class="line none">  715 /**</div><div id="716" class="line none">  716  * @brief Get the statistics of OTA message packets.</div><div id="717" class="line none">  717  *</div><div id="718" class="line none">  718  * Packet statistics are:</div><div id="719" class="line none">  719  * &lt;ul&gt;</div><div id="720" class="line none">  720  *  &lt;li&gt; Received: The number of OTA packets that have been received</div><div id="721" class="line none">  721  *  but not necessarily queued for processing by the OTA agent.</div><div id="722" class="line none">  722  *  &lt;li&gt; Queued: The number of OTA packets that have been queued for</div><div id="723" class="line none">  723  *  processing. This implies there was a free message queue entry so</div><div id="724" class="line none">  724  *  it can be passed to the agent for processing.</div><div id="725" class="line none">  725  *  &lt;li&gt; Processed: The number of OTA packets that have actually been</div><div id="726" class="line none">  726  *  processed.</div><div id="727" class="line none">  727  *  &lt;li&gt; Dropped: The number of OTA packets that have been dropped</div><div id="728" class="line none">  728  *  because of either no queue or at shutdown cleanup.</div><div id="729" class="line none">  729  *&lt;/ul&gt;</div><div id="730" class="line none">  730  * @note Calling @ref OTA_Init will reset this statistic.</div><div id="731" class="line none">  731  *</div><div id="732" class="line none">  732  * @return OtaErrNone if the statistics can be received successfully.</div><div id="733" class="line none">  733  *</div><div id="734" class="line none">  734  * &lt;b&gt;Example&lt;/b&gt;</div><div id="735" class="line none">  735  * @code{c}</div><div id="736" class="line none">  736  * // OTA library packet statistics per job.</div><div id="737" class="line none">  737  * OtaAgentStatistics_t otaStatistics = { 0 };</div><div id="738" class="line none">  738  * OtaErr_t otaErr = OtaErrNone;</div><div id="739" class="line none">  739  *</div><div id="740" class="line none">  740  * // Get the current statistics from the agent.</div><div id="741" class="line none">  741  * otaErr = OTA_GetStatistics( &amp;otaStatistics );</div><div id="742" class="line none">  742  *</div><div id="743" class="line none">  743  * if( otaErr != OtaErrNone )</div><div id="744" class="line none">  744  * {</div><div id="745" class="line none">  745  *     printf( " Received: %u   Queued: %u   Processed: %u   Dropped: %u",</div><div id="746" class="line none">  746  *             otaStatistics.otaPacketsReceived,</div><div id="747" class="line none">  747  *             otaStatistics.otaPacketsQueued,</div><div id="748" class="line none">  748  *             otaStatistics.otaPacketsProcessed,</div><div id="749" class="line none">  749  *             otaStatistics.otaPacketsDropped );</div><div id="750" class="line none">  750  * }</div><div id="751" class="line none">  751  * @endcode</div><div id="752" class="line none">  752  */</div><div id="753" class="line none">  753 /* @[declare_ota_getstatistics] */</div><div id="754" class="line none">  754 <a href="ota.h.html#97">OtaErr_t</a> OTA_GetStatistics( <a href="ota_private.h.html#290">OtaAgentStatistics_t</a> * pStatistics );</div><div id="755" class="line none">  755 /* @[declare_ota_getstatistics] */</div><div id="756" class="line none">  756 </div><div id="757" class="line none">  757 /**</div><div id="758" class="line none">  758  * @brief Error code to string conversion for OTA errors.</div><div id="759" class="line none">  759  *</div><div id="760" class="line none">  760  * @param[in] err The error to convert to a string.</div><div id="761" class="line none">  761  *</div><div id="762" class="line none">  762  * @return The string representation of the error.</div><div id="763" class="line none">  763  */</div><div id="764" class="line none">  764 /* @[declare_ota_err_strerror] */</div><div id="765" class="line none">  765 const char * OTA_Err_strerror( <a href="ota.h.html#97">OtaErr_t</a> err );</div><div id="766" class="line none">  766 /* @[declare_ota_err_strerror] */</div><div id="767" class="line none">  767 </div><div id="768" class="line none">  768 /**</div><div id="769" class="line none">  769  * @brief Error code to string conversion for OTA Job Parsing errors.</div><div id="770" class="line none">  770  *</div><div id="771" class="line none">  771  * @param[in] err The error to convert to a string.</div><div id="772" class="line none">  772  *</div><div id="773" class="line none">  773  * @return The string representation of the error.</div><div id="774" class="line none">  774  */</div><div id="775" class="line none">  775 /* @[declare_ota_jobparse_strerror] */</div><div id="776" class="line none">  776 const char * OTA_JobParse_strerror( <a href="ota.h.html#139">OtaJobParseErr_t</a> err );</div><div id="777" class="line none">  777 /* @[declare_ota_jobparse_strerror] */</div><div id="778" class="line none">  778 </div><div id="779" class="line none">  779 /**</div><div id="780" class="line none">  780  * @brief Status code to string conversion for OTA PAL status.</div><div id="781" class="line none">  781  *</div><div id="782" class="line none">  782  * @param[in] status The status to convert to a string.</div><div id="783" class="line none">  783  *</div><div id="784" class="line none">  784  * @return The string representation of the status.</div><div id="785" class="line none">  785  */</div><div id="786" class="line none">  786 /* @[declare_ota_palstatus_strerror] */</div><div id="787" class="line none">  787 const char * OTA_PalStatus_strerror( <a href="ota_platform_interface.h.html#90">OtaPalMainStatus_t</a> <a href="ota.h.html#202">status</a> );</div><div id="788" class="line none">  788 /* @[declare_ota_palstatus_strerror] */</div><div id="789" class="line none">  789 </div><div id="790" class="line none">  790 /**</div><div id="791" class="line none">  791  * @brief Status code to string conversion for OTA OS status.</div><div id="792" class="line none">  792  *</div><div id="793" class="line none">  793  * @param[in] status The status to convert to a string.</div><div id="794" class="line none">  794  *</div><div id="795" class="line none">  795  * @return The string representation of the status.</div><div id="796" class="line none">  796  */</div><div id="797" class="line none">  797 /* @[declare_ota_osstatus_strerror] */</div><div id="798" class="line none">  798 const char * OTA_OsStatus_strerror( <a href="ota_os_interface.h.html#104">OtaOsStatus_t</a> <a href="ota.h.html#202">status</a> );</div><div id="799" class="line none">  799 /* @[declare_ota_osstatus_strerror] */</div><div id="800" class="line none">  800 </div><div id="801" class="line none">  801 #endif /* ifndef OTA_H */</div>
</div>
</body>
</html>
